<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>DSA Lab System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      margin: 0;
      background: radial-gradient(circle at top, #e5f3ea 0, #f5f7fb 48%, #f1f5f9 100%);
      color: #1f2933;
    }
    .app {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 28px 10px 40px;
    }
    .card {
      background: #ffffff;
      border-radius: 18px;
      box-shadow: 0 14px 36px rgba(15, 23, 42, 0.12);
      padding: 24px 22px;
      width: 100%;
      max-width: 540px;
      position: relative;
      overflow: hidden;
    }
    h1,h2,h3 {
      margin: 0 0 10px;
    }
    h1 { font-size: 1.5rem; }
    h2 { font-size: 1.2rem; }
    p { margin: 6px 0; }

    .app-title {
      font-size: 1.35rem;
      font-weight: 800;
      margin-bottom: 4px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .app-title span.logo {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #bbf7d0, #22c55e);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-weight:800;
      box-shadow:0 10px 24px rgba(22,163,74,0.55);
    }
    .app-sub {
      font-size:0.85rem;
      color:#6b7280;
      margin-bottom:18px;
    }

    .view { display:none; }
    .view.active { display:block; }

    .field { margin-bottom:12px; }
    .field label {
      display:block;
      font-size:0.85rem;
      margin-bottom:4px;
    }
    .field small { font-size:0.75rem;color:#6b7280; }

    .input, select, textarea {
      width:100%;
      padding:9px 10px;
      border-radius:10px;
      border:1px solid #cbd5e1;
      font-size:0.9rem;
      background:#f9fafb;
      transition:border-color 0.15s, box-shadow 0.15s, background-color 0.15s;
    }
    .input:focus, select:focus, textarea:focus {
      outline:none;
      border-color:#15803d;
      background:#ffffff;
      box-shadow:0 0 0 1px rgba(22,163,74,0.35);
    }
    textarea { resize:vertical; min-height:64px; }

    .btn {
      display:inline-block;
      border:none;
      border-radius:999px;
      padding:10px 18px;
      font-size:0.92rem;
      cursor:pointer;
      background:linear-gradient(135deg,#15803d,#22c55e);
      color:#ffffff;
      font-weight:600;
      box-shadow:0 10px 20px rgba(22,163,74,0.45);
      text-align:center;
    }
    .btn.full { width:100%; }
    .btn.secondary {
      background:#e5e7eb;
      color:#111827;
      box-shadow:none;
    }
    .btn.secondary:hover {
      box-shadow:0 6px 12px rgba(15,23,42,0.15);
    }
    .btn:active {
      transform:translateY(1px);
      box-shadow:0 6px 12px rgba(22,163,74,0.3);
    }

    .muted { color:#6b7280;font-size:0.85rem; }
    .top-title {
      font-size:0.8rem;
      color:#6b7280;
      margin-bottom:4px;
      text-transform:uppercase;
      letter-spacing:0.05em;
    }

    .greeting-main {
      font-size:1.05rem;
      line-height:1.7;
      margin-bottom:6px;
    }
    .greeting-en { font-size:0.9rem;color:#4b5563; }

    .chip {
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:#e8f5e9;
      color:#166534;
      font-size:0.8rem;
      margin-bottom:8px;
    }

    .dashboard-grid {
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
      margin-top:10px;
    }
    .dash-item {
      padding:10px 12px;
      border-radius:12px;
      background:#ffffff;
      border:1px solid #e2e8f0;
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:pointer;
      transition:box-shadow 0.15s, transform 0.1s, border-color 0.15s;
      font-size:0.9rem;
    }
    .dash-item:hover {
      box-shadow:0 10px 22px rgba(15,23,42,0.16);
      transform:translateY(-1px);
      border-color:#bbf7d0;
    }
    .dash-item span.icon { font-size:1.2rem; }

    .case-summary {
      margin-top:10px;
      padding:10px 12px;
      background:#f9fafb;
      border-radius:10px;
      border:1px dashed #d1d5db;
      font-size:0.85rem;
    }

    .tag {
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:0.78rem;
    }
    .tag.green { background:#e8f5e9;color:#166534; }
    .tag.blue { background:#e0f2fe;color:#1d4ed8; }
    .tag.orange{ background:#fff7ed;color:#c05621; }
    .tag.red{ background:#fee2e2;color:#b91c1c; }

    .qr-box { text-align:center;margin-top:10px; }
    .qr-box img {
      margin-top:6px;
      background:#fff;
      padding:6px;
      border-radius:8px;
      border:1px solid #e5e7eb;
    }

    canvas {
      width:100%;
      max-width:100%;
      background:#f3f4f6;
      border-radius:10px;
      border:1px solid #d1d5db;
      margin-top:6px;
    }

    .stats-block {
      margin-top:10px;
      padding:10px 12px;
      background:#f9fafb;
      border-radius:10px;
      border:1px solid #e5e7eb;
      font-size:0.85rem;
    }
    .stats-row {
      display:flex;
      justify-content:space-between;
      margin:2px 0;
    }
    .bar {
      margin-top:4px;
      height:6px;
      border-radius:999px;
      background:#e5e7eb;
      overflow:hidden;
    }
    .bar-fill {
      height:100%;
      border-radius:inherit;
      background:linear-gradient(90deg,#22c55e,#4ade80);
      width:40%;
    }

    .two-col {
      display:grid;
      grid-template-columns:1fr;
      gap:8px;
    }
    @media(min-width:640px){
      .two-col { grid-template-columns:1fr 1fr; }
    }

    /* Floating Settings FAB */
    .fab {
      position:fixed;
      inset-inline-start:16px;
      inset-block-start:20px;
      width:44px;
      height:44px;
      border-radius:999px;
      background:#a9d5b3;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 10px 24px rgba(22,101,52,0.4);
      cursor:pointer;
      z-index:1001;
      transition:transform 0.1s, box-shadow 0.15s;
    }
    .fab span {
      font-size:1.25rem;
      color:#123827;
    }
    .fab:hover {
      transform:translateY(-1px);
      box-shadow:0 14px 30px rgba(22,101,52,0.5);
    }

    /* Settings side panel */
    .settings-overlay {
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.32);
      display:flex;
      justify-content:flex-start;
      align-items:stretch;
      z-index:1000;
    }
    .settings-overlay.hidden { display:none; }
    .settings-panel {
      width:320px;
      max-width:80%;
      background:#ffffff;
      box-shadow:4px 0 24px rgba(15,23,42,0.36);
      padding:18px 16px 20px;
      overflow-y:auto;
    }
    .settings-title {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:8px;
    }
    .settings-title h3 {
      margin:0;
      font-size:1.05rem;
    }
    .settings-section-title {
      font-size:0.9rem;
      font-weight:600;
      margin-top:10px;
      margin-bottom:4px;
      display:flex;
      align-items:center;
      gap:4px;
    }
    .settings-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:4px;
      font-size:0.8rem;
      padding:4px 0;
      border-bottom:1px solid #f3f4f6;
    }
    .settings-row:last-child { border-bottom:none; }

    .small-select {
      font-size:0.78rem;
      padding:3px 6px;
      border-radius:999px;
      border:1px solid #cbd5e1;
      background:#f9fafb;
    }
    .small-input {
      width:100%;
      font-size:0.8rem;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #cbd5e1;
      background:#f9fafb;
      margin-bottom:4px;
    }
    .btn-mini {
      padding:6px 10px;
      border-radius:999px;
      border:none;
      font-size:0.78rem;
      cursor:pointer;
      background:#e5e7eb;
      margin-top:4px;
    }

    .settings-hint { font-size:0.75rem;color:#6b7280;margin-top:4px; }

    /* Helper */
    .center { text-align:center; }

    @media(min-width:768px){
      .app { align-items:center; }
    }
  </style>
</head>
<body>
  <!-- Floating Settings Button -->
  <div class="fab" onclick="openSettingsPin()">
    <span>âš™ï¸</span>
  </div>

  <!-- SETTINGS SIDE PANEL -->
  <div id="settingsOverlay" class="settings-overlay hidden" onclick="closeSettingsOverlay(event)">
    <div class="settings-panel">
      <div class="settings-title">
        <h3>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª / Settings</h3>
        <button class="btn-mini" onclick="closeSettingsPanel()">âœ–</button>
      </div>
      <div class="muted" style="font-size:0.8rem;margin-bottom:6px;">
        Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ùƒ Ø£Ù†Øª ÙÙ‚Ø· ÙŠØ§ Ù…Ø´Ø±ÙØ© Ø§Ù„Ù†Ø¸Ø§Ù… ğŸ¤
      </div>

      <!-- Technicians -->
      <div class="settings-section-title">ğŸ§‘â€ğŸ”§ Ø§Ù„ÙÙ†ÙŠÙŠÙ† / Technicians</div>
      <div id="techSettingsContainer" class="muted" style="font-size:0.78rem;"></div>
      <button class="btn-mini" onclick="saveTechSettings()">Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ÙÙ†ÙŠÙŠÙ†</button>
      <div class="settings-hint">Active: ÙŠØ¯Ø®Ù„ ÙÙŠ Ø§Ù„ØªÙˆØ²ÙŠØ¹ â€¢ On Leave: Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØªØ¬Ø§ÙˆØ²Ù‡ â€¢ Inactive: Ù„Ø§ ÙŠÙØ³ØªØ®Ø¯Ù….</div>

      <!-- Rejected Cases -->
      <div class="settings-section-title">ğŸš« Ø­Ø§Ù„Ø§Øª Ù…Ø±ÙÙˆØ¶Ø© / Rejected Cases</div>
      <input id="rejFileInput" class="small-input" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù / File number" />
      <input id="rejReasonInput" class="small-input" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶ / Reason" />
      <button class="btn-mini" onclick="addRejectedCase()">Ø¥Ø¶Ø§ÙØ© / Add</button>
      <div id="rejList" class="muted" style="margin-top:6px;font-size:0.78rem;"></div>

      <!-- System Info -->
      <div class="settings-section-title">âš™ï¸ Ø£Ø±Ù‚Ø§Ù… Ø³Ø±ÙŠØ© / Security</div>
      <div class="settings-row">
        <span>Statistics PIN</span>
        <span class="muted" style="font-size:0.8rem;">Ø­Ø§Ù„ÙŠØ§Ù‹ Ø«Ø§Ø¨Øª ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ (ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡ Ù…Ù† Ø§Ù„Ù…Ø·ÙˆØ±).</span>
      </div>
      <div class="settings-row">
        <span>Settings PIN</span>
        <span class="muted" style="font-size:0.8rem;">Ø­Ø§Ù„ÙŠØ§Ù‹ Ø«Ø§Ø¨Øª ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ (Ù„Ù„ØªØ¬Ø±Ø¨Ø©).</span>
      </div>
    </div>
  </div>

  <div class="app">
    <!-- LOGIN PAGE -->
    <section id="loginPage" class="view active">
      <div class="card">
        <div class="app-title">
          <span class="logo">DS</span>
          DSA Lab System
        </div>
        <div class="app-sub">Ù†Ø¸Ø§Ù… Ø¨Ø³ÙŠØ· Ù„Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø§Øª Ù…Ø¹Ù…Ù„ Ø§Ù„Ø£Ø³Ù†Ø§Ù† â€“ Ø¹ÙŠØ§Ø¯Ø©ØŒ Ù…Ø¹Ù…Ù„ØŒ ÙÙ†ÙŠÙŠÙ†ØŒ ÙˆØ¥Ø­ØµØ§Ø¦ÙŠØ§Øª.</div>

        <div class="top-title">Login â€¢ Ø¯Ø®ÙˆÙ„</div>
        <h1>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Login</h1>
        <p class="muted">Ø£Ø¯Ø®Ù„ÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…ÙˆØ­Ø¯Ø© Ù„Ù„ÙØ±ÙŠÙ‚.</p>
        <div class="field">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… / Username</label>
          <input id="loginUsername" class="input" type="text" placeholder="Ù…Ø«Ø§Ù„: wedad" />
        </div>
        <div class="field">
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± / Password</label>
          <input id="loginPassword" class="input" type="password" placeholder="â€¢â€¢â€¢â€¢" />
        </div>
        <button class="btn full" onclick="handleLogin()">Ø¯Ø®ÙˆÙ„ / Login</button>
        <p id="loginError" class="muted" style="color:#b91c1c;display:none;margin-top:8px;">
          Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©ØŒ ØªØ£ÙƒØ¯ÙŠ Ù…Ù† Ø§Ù„Ø§Ø³Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.
        </p>
      </div>
    </section>

    <!-- GREETING PAGE -->
    <section id="greetingPage" class="view">
      <div class="card">
        <div class="chip">ğŸ’š Lab Vibes â€¢ Ù…Ø²Ø§Ø¬ Ø§Ù„Ù…Ø¹Ù…Ù„</div>
        <h1>ÙŠØ§ Ù…Ø±Ø­Ø¨Ø§Ù‹ / Welcome</h1>
        <p id="greetingAr" class="greeting-main"></p>
        <p id="greetingEn" class="greeting-en"></p>
        <button class="btn full" style="margin-top:16px;" onclick="goToDashboard()">
          Ù„Ù†Ø¨Ø¯Ø£ Ø§Ù„Ù†Ø¸Ø§Ù… / Start the system ğŸš€
        </button>
        <button class="btn secondary full" style="margin-top:8px;" onclick="logout()">
          ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ / Logout
        </button>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="dashboardPage" class="view">
      <div class="card">
        <div class="top-title">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… / Dashboard</div>
        <h1>DSA Lab Workflow</h1>
        <p class="muted">Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ø§ ØªØ±ÙŠØ¯ÙŠÙ† Ø¥Ù†Ø¬Ø§Ø²Ù‡ Ø§Ù„ÙŠÙˆÙ… / Choose your action:</p>
        <div class="dashboard-grid">
          <div class="dash-item" onclick="showView('clinicFormPage')">
            <div>
              ğŸ“ Ø¥Ø¯Ø®Ø§Ù„ Ø­Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© / Clinic Entry
              <div class="muted">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø±Ø­Ù„Ø© Ù…Ù† Ø§Ù„ÙƒØ±Ø³ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¹Ù…Ù„ / From chair to lab</div>
            </div>
            <span class="icon">â•</span>
          </div>
          <div class="dash-item" onclick="showView('receivePage')">
            <div>
              ğŸ“¦ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù…Ø¹Ù…Ù„ / Lab Receiving
              <div class="muted">ØªØ£ÙƒÙŠØ¯ ÙˆØµÙˆÙ„ + ØªÙˆÙ‚ÙŠØ¹ + Ø¨ÙŠØ§Ù†Ø§Øª</div>
            </div>
            <span class="icon">âœï¸</span>
          </div>
          <div class="dash-item" onclick="showView('techDispatchPage')">
            <div>
              ğŸ§‘â€ğŸ”§ Ù…Ù† Ø§Ù„ÙÙ†ÙŠ Ø¥Ù„Ù‰ RDC/Box / Tech â†’ RDC
              <div class="muted">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø¹Ù„Ù‰ RDC1 / RDC2 / Box / Clinic</div>
            </div>
            <span class="icon">ğŸ“¤</span>
          </div>
          <div class="dash-item" onclick="showView('assistantReceivePage')">
            <div>
              ğŸ¦· Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© / Assistant Receive
              <div class="muted">Scan QR + ØªÙˆÙ‚ÙŠØ¹ + Ø¹Ø¨Ø§Ø±Ø© ØªØ­ÙÙŠØ²ÙŠØ©</div>
            </div>
            <span class="icon">âœ…</span>
          </div>
          <div class="dash-item" onclick="openStatsPin()">
            <div>
              ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª / Statistics
              <div class="muted">Ù…Ø­Ø¬ÙˆØ¨Ø© Ø¨Ø±Ù‚Ù… Ø³Ø±ÙŠ Ø®Ø§Øµ / Protected</div>
            </div>
            <span class="icon">ğŸ”</span>
          </div>
        </div>
        <button class="btn secondary full" style="margin-top:16px;" onclick="logout()">
          ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬ / Logout
        </button>
      </div>
    </section>

    <!-- CLINIC FORM PAGE -->
    <section id="clinicFormPage" class="view">
      <div class="card">
        <div class="top-title">Step 1 â€¢ Clinic Entry</div>
        <h2>ØªØ³Ø¬ÙŠÙ„ Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© / New Case</h2>
        <div class="field">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù / File Number</label>
          <input id="fileNumber" class="input" type="text" />
        </div>
        <div class="field">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ / Patient Name</label>
          <input id="patientName" class="input" type="text" />
        </div>
        <div class="two-col">
          <div class="field">
            <label>Ø±Ù‚Ù… Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© / Clinic No.</label>
            <input id="clinicNumber" class="input" type="text" />
          </div>
          <div class="field">
            <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨ / Doctor Name</label>
            <input id="doctorName" class="input" type="text" />
          </div>
        </div>
        <div class="two-col">
          <div class="field">
            <label>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„Ø© / Case Type â€“ Department</label>
            <select id="caseType">
              <option value="">Ø§Ø®ØªØ§Ø±ÙŠ / Select...</option>
              <option value="RPD">RPD â€“ Removable Partial</option>
              <option value="CD">CD â€“ Complete Denture</option>
              <option value="PFM">Crown / PFM</option>
              <option value="ORTHO">Ortho</option>
              <option value="TM">TM / Wax / Setup</option>
              <option value="IMPLANT">Implant</option>
              <option value="OTHER">Other</option>
            </select>
          </div>
          <div class="field">
            <label>Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù…Ø±ÙŠØ¶ Ø§Ù„Ù‚Ø§Ø¯Ù… / Next Appointment Date</label>
            <input id="nextAppt" class="input" type="date" />
          </div>
        </div>
        <div class="field">
          <label>ØµÙˆØ±Ø© Ø£Ùˆ Snap Ù„Ù„Ø·Ù„Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) / Optional order image</label>
          <input id="orderImage" class="input" type="file" accept="image/*" />
        </div>
        <button class="btn full" onclick="createClinicCase()">Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØªÙˆØ²ÙŠØ¹Ù‡Ø§ âœ… / Save & Assign</button>
        <button class="btn secondary full" style="margin-top:8px;" onclick="showView('dashboardPage')">
          Ø±Ø¬ÙˆØ¹ / Back
        </button>

        <!-- Search existing case -->
        <div style="margin-top:14px;">
          <div class="top-title">Ø¨Ø­Ø« / Search</div>
          <div class="field">
            <label>Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ù…Ù„ Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ / Search by file, lab no., or name</label>
            <input id="clinicSearchInput" class="input" type="text" placeholder="Ù…Ø«Ø§Ù„: 12345 Ø£Ùˆ LAB-1001 Ø£Ùˆ Ahmed" />
          </div>
          <button class="btn secondary full" onclick="searchCaseFromClinic()">Ø¨Ø­Ø« / Search</button>
        </div>

        <div id="clinicResult" class="case-summary" style="display:none;"></div>
        <div id="qrBox" class="qr-box" style="display:none;"></div>
      </div>
    </section>

    <!-- LAB RECEIVE PAGE -->
    <section id="receivePage" class="view">
      <div class="card">
        <div class="top-title">Step 2 â€¢ Lab Receiving</div>
        <h2>Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù…Ø¹Ù…Ù„ / Receive in Lab</h2>
        <div class="field">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ù…Ù„ Ø£Ùˆ Ø§Ù„Ù…Ù„Ù / Lab Number or File No.</label>
          <input id="receiveSearchInput" class="input" type="text" placeholder="LAB-1001 Ø£Ùˆ 12345" />
        </div>
        <button class="btn full" onclick="findCaseForReceive()">Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø­Ø§Ù„Ø© / Search</button>
        <button class="btn secondary full" style="margin-top:8px;" onclick="showView('dashboardPage')">
          Ø±Ø¬ÙˆØ¹ / Back
        </button>

        <div id="receiveDetails" style="display:none;margin-top:14px;">
          <div class="case-summary" id="receiveSummary"></div>

          <div class="two-col">
            <div class="field">
              <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù… / Receiver Name</label>
              <input id="receiverName" class="input" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ / Ø§Ù„ÙÙ†ÙŠ" />
            </div>
            <div class="field">
              <label>ØªØ§Ø±ÙŠØ® Ù…ØªÙˆÙ‚Ø¹ Ù„Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ / Expected Finish Date</label>
              <input id="expectedFinish" class="input" type="date" />
            </div>
          </div>

          <div class="field">
            <label>ØªØ§Ø±ÙŠØ® Ù…ØªÙˆÙ‚Ø¹ Ù„Ù„ØªØ³Ù„ÙŠÙ… Ù„Ù„Ø¹ÙŠØ§Ø¯Ø© / Expected Delivery to Clinic</label>
            <input id="expectedDelivery" class="input" type="date" />
          </div>

          <div class="field">
            <label>ØªÙˆÙ‚ÙŠØ¹ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ / Digital Signature</label>
            <canvas id="signCanvas" height="160"></canvas>
            <button class="btn secondary full" style="margin-top:6px;" onclick="clearSignature()">Ù…Ø³Ø­ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ / Clear signature</button>
          </div>

          <div class="field">
            <label>Ø±ÙØ¹ Scan Ù„Ù„Ø­Ø§Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) / Scan image (optional)</label>
            <input id="receiveScan" class="input" type="file" accept="image/*" />
          </div>

          <button class="btn full" onclick="confirmReceive()">ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø­Ø§Ù„Ø© âœ… / Confirm Receive</button>
          <p id="receiveMsg" class="muted" style="display:none;margin-top:10px;color:#166534;">
            ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­ØŒ Ø´ÙƒØ±Ø§Ù‹ Ù„Ø­Ø±ØµÙƒâ€¦ You just made the workflow clearer âœ¨
          </p>
        </div>
      </div>
    </section>

    <!-- TECH DISPATCH PAGE -->
    <section id="techDispatchPage" class="view">
      <div class="card">
        <div class="top-title">Step 3 â€¢ Tech â†’ RDC / Box</div>
        <h2>Ù…Ù† Ø§Ù„ÙÙ†ÙŠ Ø¥Ù„Ù‰ RDC/Box/Clinic</h2>
        <p class="muted">Ù‡Ù†Ø§ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„ØªØ³Ù„ÙŠÙ… Ù…Ù† Ø§Ù„Ù…Ø¹Ù…Ù„ Ù„Ù„Ø¹ÙŠØ§Ø¯Ø§Øª Ø£Ùˆ Ø§Ù„Ù€ RDC.</p>

        <div class="field">
          <label>Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ù…Ù„ / Ø§Ù„Ù…Ù„Ù / Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ / Search</label>
          <input id="techDispatchSearch" class="input" type="text" placeholder="LAB-1001 Ø£Ùˆ 12345 Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…" />
        </div>
        <button class="btn secondary full" onclick="renderTechDispatch()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© / Refresh</button>
        <button class="btn secondary full" style="margin-top:6px;" onclick="showView('dashboardPage')">
          Ø±Ø¬ÙˆØ¹ / Back
        </button>

        <div id="techDispatchList" style="margin-top:12px;font-size:0.85rem;"></div>
      </div>
    </section>

    <!-- ASSISTANT RECEIVE PAGE (CLINIC) -->
    <section id="assistantReceivePage" class="view">
      <div class="card">
        <div class="top-title">Step 4 â€¢ Clinic Assistant</div>
        <h2>Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© / Assistant Receive</h2>
        <p class="muted">Scan Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ù…Ù„ Ø£Ùˆ QR (Ø§ÙƒØªØ¨ÙŠÙ‡ Ù‡Ù†Ø§) Ù„Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆØ§Ù„ØªÙˆÙ‚ÙŠØ¹.</p>
        <div class="field">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ù…Ù„ / Lab Number</label>
          <input id="assistLabInput" class="input" type="text" placeholder="LAB-1001" />
        </div>
        <button class="btn full" onclick="loadAssistCase()">Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø§Ù„Ø© / Show Case</button>
        <button class="btn secondary full" style="margin-top:8px;" onclick="showView('dashboardPage')">
          Ø±Ø¬ÙˆØ¹ / Back
        </button>

        <div id="assistDetails" style="display:none;margin-top:14px;">
          <div class="case-summary" id="assistSummary"></div>

          <div class="field">
            <label>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© / Assistant Signature</label>
            <canvas id="assistSignCanvas" height="150"></canvas>
            <button class="btn secondary full" style="margin-top:6px;" onclick="clearAssistSignature()">Ù…Ø³Ø­ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ / Clear</button>
          </div>

          <button class="btn full" onclick="confirmAssistReceive()">ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© âœ…</button>
          <p id="assistMsg" class="muted" style="display:none;margin-top:10px;color:#166534;">
            ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­ ğŸ¤  
            "Ø´ÙƒØ±Ø§Ù‹ Ù„Ø­Ø±ØµÙƒâ€¦ ÙƒÙ„ Ø­Ø§Ù„Ø© ØªØ³ØªÙ„Ù…ÙŠÙ†Ù‡Ø§ ØªØ¹Ù†ÙŠ Ø§Ø¨ØªØ³Ø§Ù…Ø© Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø¸Ù‡ÙˆØ± ğŸ’š"
          </p>
        </div>
      </div>
    </section>

    <!-- STATS PIN PAGE -->
    <section id="statsPinPage" class="view">
      <div class="card">
        <div class="top-title">ğŸ” Protected</div>
        <h2>Ø¯Ø®ÙˆÙ„ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª / Statistics PIN</h2>
        <p class="muted">Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ùƒ Ø£Ù†Øª ÙÙ‚Ø· ÙŠØ§ Ù…Ø´Ø±ÙØ© Ø§Ù„Ù…Ø¹Ù…Ù„.</p>
        <div class="field">
          <label>Statistics PIN</label>
          <input id="statsPinInput" class="input" type="password" />
        </div>
        <button class="btn full" onclick="checkStatsPin()">Ø¯Ø®ÙˆÙ„ / Enter</button>
        <button class="btn secondary full" style="margin-top:8px;" onclick="showView('dashboardPage')">
          Ø±Ø¬ÙˆØ¹ / Back
        </button>
        <p id="statsPinError" class="muted" style="display:none;color:#b91c1c;margin-top:8px;">
          Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­.
        </p>
      </div>
    </section>

    <!-- STATS PAGE -->
    <section id="statsPage" class="view">
      <div class="card">
        <div class="top-title">ğŸ“Š Lab Analytics</div>
        <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª / Statistics Dashboard</h2>
        <p class="muted">ÙŠØ§ Ù…Ø±Ø­Ø¨Ø§ Ù‚Ø§Ø¦Ø¯Ø© Ø§Ù„Ù…Ø¹Ù…Ù„â€¦ Ø¬Ø§Ù‡Ø²Ø© Ù†Ø´ÙˆÙ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…ØŸ ÙŠØ§Ø±Ø¨ ØªØ¨Ø´Ø±Ùƒ Ø¨Ø§Ù„Ø®ÙŠØ± Ø¯Ø§Ø¦Ù…Ø§Ù‹ ğŸ’š</p>
        <div id="statsContent" class="stats-block"></div>

        <button class="btn secondary full" style="margin-top:12px;" onclick="showView('dashboardPage')">
          Ø±Ø¬ÙˆØ¹ / Back
        </button>
      </div>
    </section>
  </div>

  <script>
    // ===== BASIC CONFIG =====
    const LOGIN_USER   = "wedad"; // Ø§Ø³Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    const LOGIN_PASS   = "1234";  // ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ø¬Ù…ÙŠØ¹
    const STATS_PIN    = "2580";  // Ø±Ù‚Ù… Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    const SETTINGS_PIN = "8642";  // Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª

    const greetings = [
      {
        ar: "ÙŠØ§ Ù…Ø±Ø­Ø¨Ø§ ğŸ¤ Ø¬Ø§Ù‡Ø²ÙŠÙ† Ù†Ø´ÙˆÙ Ø§Ù„Ù†Ø¸Ø§Ù…ØŸ ÙŠØ§Ø±Ø¨ ØªØ¨Ø´Ù‘Ø± Ø®Ø·ÙˆØ§ØªÙƒÙ… Ø¨Ø§Ù„Ø®ÙŠØ± ğŸ’š",
        en: "Welcome! Ready to see todayâ€™s workflow? May every case bring good news ğŸ’š"
      },
      {
        ar: "Ù†ÙˆØ±ØªÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… ğŸ¤ Ø§Ù„ÙŠÙˆÙ… ÙŠÙˆÙ… Ø¥Ù†Ø¬Ø§Ø²â€¦ Ø¬Ø§Ù‡Ø²ÙŠÙ†ØŸ ÙŠØ§Ø±Ø¨ ÙŠØ¬Ø¹Ù„Ù‡Ø§ Ø¨Ø¯Ø§ÙŠØ© Ø®ÙŠØ± ğŸ’š",
        en: "You just lit up the system ğŸ¤ Let today be full of smooth wins ğŸ’š"
      },
      {
        ar: "Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙØ±ÙŠÙ‚ Ø§Ù„Ù…Ø¹Ù…Ù„ Ø§Ù„Ù…Ø¨Ø¯Ø¹ âœ¨ Ø®Ø°ÙˆØ§ Ù†ÙØ³ Ø¹Ù…ÙŠÙ‚ ÙˆØ®Ù„ÙˆÙ†Ø§ Ù†Ø±ØªÙ‘Ø¨ ÙŠÙˆÙ…Ù†Ø§ Ø³ÙˆØ§ ğŸ’š",
        en: "Hello creative lab team âœ¨ Deep breathâ€¦ letâ€™s organize the whole day together ğŸ’š"
      }
    ];

    // Technicians mapping (final)
    const techniciansByDept = {
      RPD: [
        "AlSharfan RPD",
        "Alsakhri RPD",
        "Abdullatif RPD",
        "HAYAM RPD",
        "RASHEED RPD",
        "MANSOR RPD",
        "ABDULLAH RPD",
        "Faisal RPD",
        "Alaa RPD"
      ],
      CD: [
        "Qasem CD",
        "Kushan CD",
        "ALQAHTANI CD",
        "yahya CD",
        "Abdullah CD",
        "ALSHAHRANI CD"
      ],
      PFM: [
        "Ayman PFM",
        "Sultan PFM"
      ],
      ORTHO: [
        "Turki O",
        "Waleed O"
      ],
      TM: [
        "Ahamed TM",
        "Aloud TM",
        "Alkhamis TM",
        "W.Alsuwiri TM",
        "Alotaibi TM"
      ],
      OTHER: []
    };

    // ===== STORAGE =====
    function loadJSON(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        return raw ? JSON.parse(raw) : fallback;
      } catch(e) {
        console.error(e);
        return fallback;
      }
    }
    function saveJSON(key, value) {
      localStorage.setItem(key, JSON.stringify(value));
    }

    let cases = loadJSON("dsa_cases", []);
    let rejectedCases = loadJSON("dsa_rejected", []); // {fileNumber, reason}
    let techStatus = loadJSON("dsa_techStatus", {});  // name -> "Active"/"Leave"/"Inactive"

    let currentReceiveCaseId = null;
    let currentAssistCaseId  = null;

    // ===== VIEW SWITCHING =====
    function showView(id) {
      document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    // ===== LOGIN & GREETING =====
    function handleLogin() {
      const u = document.getElementById("loginUsername").value.trim().toLowerCase();
      const p = document.getElementById("loginPassword").value.trim();
      const errorEl = document.getElementById("loginError");
      if (u === LOGIN_USER.toLowerCase() && p === LOGIN_PASS) {
        errorEl.style.display = "none";
        showGreeting();
      } else {
        errorEl.style.display = "block";
      }
    }

    function showGreeting() {
      const g = greetings[Math.floor(Math.random() * greetings.length)];
      document.getElementById("greetingAr").innerText = g.ar;
      document.getElementById("greetingEn").innerText = g.en;
      showView("greetingPage");
    }

    function goToDashboard() {
      showView("dashboardPage");
    }

    function logout() {
      document.getElementById("loginUsername").value = "";
      document.getElementById("loginPassword").value = "";
      showView("loginPage");
    }

    // ===== LAB NUMBER + DEPT MAP + TECH ROTATION =====
    function generateLabNumber() {
      const last = cases.length ? cases[cases.length - 1].labNumber : null;
      if (!last) return "LAB-1001";
      const num = parseInt(last.split("-")[1] || "1000", 10) + 1;
      return "LAB-" + num;
    }

    function mapCaseTypeToDept(caseType) {
      if (caseType === "RPD") return "RPD";
      if (caseType === "CD") return "CD";
      if (caseType === "PFM") return "PFM";
      if (caseType === "ORTHO") return "ORTHO";
      if (caseType === "TM") return "TM";
      // Implant Ø£Ùˆ ØºÙŠØ± Ù…Ø­Ø¯Ø¯ â†’ TM Ø£Ùˆ OTHER Ø­Ø³Ø¨ ØªØ¹Ø¯ÙŠÙ„ Ù…Ø³ØªÙ‚Ø¨Ù„
      if (caseType === "IMPLANT") return "TM";
      return "OTHER";
    }

    function getTechStatus(name) {
      return techStatus[name] || "Active";
    }

    function getNextTechnician(deptKey) {
      const list = techniciansByDept[deptKey] && techniciansByDept[deptKey].length
        ? techniciansByDept[deptKey]
        : techniciansByDept.OTHER;
      if (!list || list.length === 0) return "Unassigned";

      const key = "rr_index_" + deptKey;
      let idx = parseInt(localStorage.getItem(key) || "0", 10);
      let tries = 0;
      while (tries < list.length) {
        const tech = list[idx % list.length];
        const status = getTechStatus(tech);
        idx = (idx + 1) % list.length;
        if (status === "Active") {
          localStorage.setItem(key, idx.toString());
          return tech;
        }
        tries++;
      }
      // Ù„Ùˆ ÙƒÙ„Ù‡Ù… On Leave / Inactive
      return "Unassigned";
    }

    // ===== REJECTED CASES =====
    function isRejectedFile(fileNumber) {
      return rejectedCases.some(r => r.fileNumber === fileNumber);
    }

    function addRejectedCase() {
      const file = document.getElementById("rejFileInput").value.trim();
      const reason = document.getElementById("rejReasonInput").value.trim();
      if (!file || !reason) {
        alert("Ø£Ø¯Ø®Ù„ÙŠ Ø±Ù‚Ù… Ù…Ù„Ù ÙˆØ³Ø¨Ø¨.");
        return;
      }
      if (!rejectedCases.some(r => r.fileNumber === file)) {
        rejectedCases.push({ fileNumber: file, reason });
        saveJSON("dsa_rejected", rejectedCases);
        document.getElementById("rejFileInput").value = "";
        document.getElementById("rejReasonInput").value = "";
        renderRejectedList();
        alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø­Ø§Ù„Ø© Ù…Ø±ÙÙˆØ¶Ø©. Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø³ØªÙÙ†Ø¨Ù‡ Ø¹Ù†Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ³Ø¬ÙŠÙ„Ù‡Ø§.");
      } else {
        alert("Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙˆØ¶.");
      }
    }

    function removeRejectedCase(fileNumber) {
      rejectedCases = rejectedCases.filter(r => r.fileNumber !== fileNumber);
      saveJSON("dsa_rejected", rejectedCases);
      renderRejectedList();
    }

    function renderRejectedList() {
      const container = document.getElementById("rejList");
      if (!container) return;
      if (!rejectedCases.length) {
        container.innerHTML = "<div class='muted'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª Ù…Ø±ÙÙˆØ¶Ø© Ù…ÙØ³Ø¬Ù„Ø©.</div>";
        return;
      }
      let html = "";
      rejectedCases.forEach(r => {
        html += `<div class="settings-row">
          <span>${r.fileNumber}</span>
          <span>${r.reason}</span>
          <button class="btn-mini" onclick="removeRejectedCase('${r.fileNumber}')">Ø­Ø°Ù</button>
        </div>`;
      });
      container.innerHTML = html;
    }

    // ===== CLINIC CASE CREATION =====
    function createClinicCase() {
      const fileNumber   = document.getElementById("fileNumber").value.trim();
      const patientName  = document.getElementById("patientName").value.trim();
      const clinicNumber = document.getElementById("clinicNumber").value.trim();
      const doctorName   = document.getElementById("doctorName").value.trim();
      const caseType     = document.getElementById("caseType").value;
      const nextAppt     = document.getElementById("nextAppt").value;

      if (!fileNumber || !patientName || !clinicNumber || !doctorName || !caseType) {
        alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø¹Ø¨Ø¦ÙŠ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸.");
        return;
      }

      if (isRejectedFile(fileNumber)) {
        alert("âš  Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ø³Ø¬Ù„Ø© ÙƒÙ…Ø±ÙÙˆØ¶Ø©. Ù„Ø§ ÙŠÙØ³Ù…Ø­ Ø¨Ø¥Ø¯Ø®Ø§Ù„Ù‡Ø§ Ù…Ù† Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø­ØªÙ‰ ØªÙØ±Ø§Ø¬Ø¹ ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.");
        return;
      }

      const now = new Date();
      const createdAt = now.toLocaleString("ar-SA", { dateStyle:"short", timeStyle:"short" });
      const labNumber = generateLabNumber();
      const deptKey   = mapCaseTypeToDept(caseType);
      const technician = getNextTechnician(deptKey);

      const newCase = {
        id: Date.now(),
        fileNumber,
        patientName,
        clinicNumber,
        doctorName,
        caseType,
        deptKey,
        createdAt,
        labNumber,
        nextAppt: nextAppt || null,
        phase: "Entered from Clinic",
        status: "IN_CLINIC",
        technician,
        receiveInfo: null,
        techInfo: null,
        deliveryInfo: null,
        assistantInfo: null
      };

      cases.push(newCase);
      saveJSON("dsa_cases", cases);

      const res = document.getElementById("clinicResult");
      res.style.display = "block";
      res.innerHTML = `
        <div><span class="tag green">ØªÙ… Ø§Ù„Ø­ÙØ¸ ğŸ‰ Saved</span></div>
        <div>Lab No: <strong>${labNumber}</strong></div>
        <div>Ø§Ù„Ù…Ø±ÙŠØ¶ / Patient: <strong>${patientName}</strong> â€¢ Ù…Ù„Ù / File: ${fileNumber}</div>
        <div>Ø¹ÙŠØ§Ø¯Ø© / Clinic: ${clinicNumber} â€¢ Ø¯ÙƒØªÙˆØ± / Dr: ${doctorName}</div>
        <div>Ø§Ù„Ù‚Ø³Ù… / Dept: ${caseType} â€¢ Ø§Ù„ÙÙ†ÙŠ / Tech: <strong>${technician}</strong></div>
        ${nextAppt ? `<div>Ù…ÙˆØ¹Ø¯ Ù‚Ø§Ø¯Ù… / Next Appt: ${nextAppt}</div>` : ""}
        <div class="muted" style="margin-top:6px;">
          Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¢Ù†: <strong>Entered from Clinic</strong>  
          ÙˆØ§Ù„Ø­Ø§Ù„Ø© Ø°Ù‡Ø¨Øª Ù„Ù„ÙÙ†ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù….
        </div>
      `;

      // QR
      const qrBox = document.getElementById("qrBox");
      const qrData = `DSA-LAB:${labNumber}`;
      qrBox.style.display = "block";
      qrBox.innerHTML = `
        <div class="muted">Scan this QR for tracking / Ø§Ù…Ø³Ø­ Ø§Ù„Ù€ QR Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­Ø§Ù„Ø©:</div>
        <img alt="QR" src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrData)}">
        <div class="muted" style="margin-top:4px;font-size:0.8rem;">Ù„Ùˆ Ù…Ø§ ÙØªØ­ Ø§Ù„Ù€ QRØŒ Ø§Ø³ØªØ®Ø¯Ù…ÙŠ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ù…Ù„ Ù…Ø¨Ø§Ø´Ø±Ø©: ${labNumber}</div>
      `;

      alert("ÙŠØ§ Ø³Ù„Ø§Ù…! Ø§Ù„Ø­Ø§Ù„Ø© Ø¯Ø®Ù„Øª Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØªÙˆØ²Ø¹Øª Ø¹Ù„Ù‰ Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ ğŸ’š");
    }

    function searchCaseFromClinic() {
      const q = document.getElementById("clinicSearchInput").value.trim().toLowerCase();
      const res = document.getElementById("clinicResult");
      if (!q) {
        res.style.display = "none";
        return;
      }
      const c = cases.find(c =>
        c.fileNumber.toLowerCase() === q ||
        c.labNumber.toLowerCase() === q ||
        c.patientName.toLowerCase().includes(q)
      );
      if (!c) {
        res.style.display = "block";
        res.innerHTML = "<div class='muted'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø© Ù…Ø·Ø§Ø¨Ù‚Ø©.</div>";
        return;
      }
      res.style.display = "block";
      res.innerHTML = `
        <div><span class="tag blue">Ù„Ù‚ÙŠÙ†Ø§ Ø§Ù„Ø­Ø§Ù„Ø© / Found</span></div>
        <div>Lab: <strong>${c.labNumber}</strong> â€¢ File: ${c.fileNumber}</div>
        <div>Patient: ${c.patientName} â€¢ Doctor: ${c.doctorName}</div>
        <div>Dept: ${c.caseType} â€¢ Tech: ${c.technician}</div>
        <div>Phase: ${c.phase}</div>
        ${c.nextAppt ? `<div>Next Appt: ${c.nextAppt}</div>` : ""}
      `;
    }

    // ===== LAB RECEIVE =====
    const receiveCanvas = document.getElementById("signCanvas");
    let receiveCtx = receiveCanvas ? receiveCanvas.getContext("2d") : null;
    let drawing = false;

    function getCanvasPos(canvas, e) {
      const rect = canvas.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      return { x: clientX - rect.left, y: clientY - rect.top };
    }

    function startDraw(e) {
      if (!receiveCtx) return;
      drawing = true;
      receiveCtx.beginPath();
      const pos = getCanvasPos(receiveCanvas, e);
      receiveCtx.moveTo(pos.x, pos.y);
    }
    function draw(e) {
      if (!drawing || !receiveCtx) return;
      const pos = getCanvasPos(receiveCanvas, e);
      receiveCtx.lineTo(pos.x, pos.y);
      receiveCtx.strokeStyle = "#10b981";
      receiveCtx.lineWidth = 2;
      receiveCtx.stroke();
    }
    function endDraw() { drawing = false; }

    if (receiveCanvas && receiveCtx) {
      receiveCanvas.addEventListener("mousedown", startDraw);
      receiveCanvas.addEventListener("mousemove", draw);
      receiveCanvas.addEventListener("mouseup", endDraw);
      receiveCanvas.addEventListener("mouseleave", endDraw);

      receiveCanvas.addEventListener("touchstart", function(e){ e.preventDefault(); startDraw(e);},{passive:false});
      receiveCanvas.addEventListener("touchmove", function(e){ e.preventDefault(); draw(e);},{passive:false});
      receiveCanvas.addEventListener("touchend", function(e){ e.preventDefault(); endDraw(e);},{passive:false});
    }

    function clearSignature() {
      if (!receiveCtx) return;
      receiveCtx.clearRect(0, 0, receiveCanvas.width, receiveCanvas.height);
    }

    function findCaseForReceive() {
      const q = document.getElementById("receiveSearchInput").value.trim().toLowerCase();
      if (!q) {
        alert("Ø§ÙƒØªØ¨ÙŠ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ù…Ù„ Ø£Ùˆ Ø§Ù„Ù…Ù„Ù.");
        return;
      }
      const c = cases.find(c =>
        c.labNumber.toLowerCase() === q ||
        c.fileNumber.toLowerCase() === q
      );
      if (!c) {
        alert("Ù…Ø§ ÙˆØ¬Ø¯Ù†Ø§ Ø­Ø§Ù„Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù….");
        return;
      }
      currentReceiveCaseId = c.id;
      const summary = document.getElementById("receiveSummary");
      summary.innerHTML = `
        <div>Ø§Ù„Ù…Ø±ÙŠØ¶ / Patient: <strong>${c.patientName}</strong> â€¢ Ù…Ù„Ù / File: ${c.fileNumber}</div>
        <div>Dept: ${c.caseType} â€¢ Tech: <strong>${c.technician}</strong></div>
        <div>Phase: <span class="tag blue">${c.phase}</span></div>
        <div class="muted">Created: ${c.createdAt} â€¢ Lab: ${c.labNumber}</div>
        ${c.nextAppt ? `<div class="muted">Next Appt: ${c.nextAppt}</div>` : ""}
      `;
      document.getElementById("receiveDetails").style.display = "block";
      document.getElementById("receiveMsg").style.display = "none";
      clearSignature();
    }

    function confirmReceive() {
      if (currentReceiveCaseId == null) {
        alert("Ø§Ø¨Ø­Ø«ÙŠ Ø¹Ù† Ø­Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹.");
        return;
      }
      const receiver = document.getElementById("receiverName").value.trim();
      const expectedFinish   = document.getElementById("expectedFinish").value;
      const expectedDelivery = document.getElementById("expectedDelivery").value;
      if (!receiver) {
        alert("Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù….");
        return;
      }
      const idx = cases.findIndex(c => c.id === currentReceiveCaseId);
      if (idx === -1) return;
      const now = new Date();
      const receiveAt = now.toLocaleString("ar-SA", { dateStyle:"short", timeStyle:"short" });

      cases[idx].phase = "Received in Lab";
      cases[idx].status = "IN_LAB";
      cases[idx].receiveInfo = {
        receiver,
        receiveAt,
        expectedFinish: expectedFinish || null,
        expectedDelivery: expectedDelivery || null
      };
      saveJSON("dsa_cases", cases);

      document.getElementById("receiveMsg").style.display = "block";
      alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù…Ø¹Ù…Ù„. ÙŠØ¹Ø·ÙŠÙƒ Ø§Ù„Ø¹Ø§ÙÙŠØ© ğŸ’š");
    }

    // ===== TECH DISPATCH =====
    function renderTechDispatch() {
      const listEl = document.getElementById("techDispatchList");
      const q = (document.getElementById("techDispatchSearch").value || "").trim().toLowerCase();
      const filtered = cases.filter(c =>
        (c.status === "IN_LAB" || c.status === "COMPLETED_IN_LAB") &&
        (!q ||
          c.labNumber.toLowerCase().includes(q) ||
          c.fileNumber.toLowerCase().includes(q) ||
          c.patientName.toLowerCase().includes(q))
      );
      if (!filtered.length) {
        listEl.innerHTML = "<div class='muted'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø§Øª Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„ØªÙˆØ²ÙŠØ¹ Ø­Ø§Ù„ÙŠØ§Ù‹.</div>";
        return;
      }
      let html = "";
      filtered.forEach(c => {
        html += `
          <div class="case-summary">
            <div><span class="tag orange">Tech â†’ RDC/Box</span></div>
            <div>Lab: <strong>${c.labNumber}</strong> â€¢ File: ${c.fileNumber}</div>
            <div>Patient: ${c.patientName} â€¢ Dept: ${c.caseType}</div>
            <div>Tech: ${c.technician}</div>
            <div>Phase: ${c.phase}</div>
            <div style="margin-top:6px;">
              <label style="font-size:0.8rem;">Destination / ÙˆØ¬Ù‡Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ…:</label>
              <select id="dest_${c.id}" class="input" style="padding:6px 8px;font-size:0.8rem;">
                <option value="">Ø§Ø®ØªØ§Ø±ÙŠ / Select...</option>
                <option value="RDC1">RDC1</option>
                <option value="RDC2">RDC2</option>
                <option value="BOX1">Box 1</option>
                <option value="BOX2">Box 2</option>
                <option value="BOX3">Box 3</option>
                <option value="CLINIC">Clinic Direct</option>
              </select>
            </div>
            <button class="btn full" style="margin-top:6px;font-size:0.82rem;" onclick="markDelivered(${c.id})">
              ØªØ£ÙƒÙŠØ¯ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ÙÙ†ÙŠ ÙˆØªØ³Ù„ÙŠÙ… / Complete & Deliver
            </button>
          </div>
        `;
      });
      listEl.innerHTML = html;
    }

    function markDelivered(caseId) {
      const cIdx = cases.findIndex(c => c.id === caseId);
      if (cIdx === -1) return;
      const dest = document.getElementById("dest_" + caseId).value;
      if (!dest) {
        alert("Ø§Ø®ØªØ§Ø±ÙŠ ÙˆØ¬Ù‡Ø© Ø§Ù„ØªØ³Ù„ÙŠÙ… Ø£ÙˆÙ„Ø§Ù‹.");
        return;
      }
      const now = new Date();
      const completedAt = now.toLocaleString("ar-SA", { dateStyle:"short", timeStyle:"short" });

      cases[cIdx].phase = "Delivered to " + dest;
      cases[cIdx].status = "DELIVERED";
      cases[cIdx].techInfo = {
        completedAt
      };
      cases[cIdx].deliveryInfo = {
        destination: dest,
        deliveredAt: completedAt
      };
      saveJSON("dsa_cases", cases);
      alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ ØªØ³Ù„ÙŠÙ… Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ " + dest + " Ø¨Ù†Ø¬Ø§Ø­ ğŸ’š");
      renderTechDispatch();
    }

    // ===== ASSISTANT RECEIVE AT CLINIC =====
    const assistCanvas = document.getElementById("assistSignCanvas");
    let assistCtx = assistCanvas ? assistCanvas.getContext("2d") : null;
    let assistDrawing = false;

    function startAssistDraw(e) {
      if (!assistCtx) return;
      assistDrawing = true;
      assistCtx.beginPath();
      const pos = getCanvasPos(assistCanvas, e);
      assistCtx.moveTo(pos.x, pos.y);
    }
    function drawAssist(e) {
      if (!assistDrawing || !assistCtx) return;
      const pos = getCanvasPos(assistCanvas, e);
      assistCtx.lineTo(pos.x, pos.y);
      assistCtx.strokeStyle = "#0f766e";
      assistCtx.lineWidth = 2;
      assistCtx.stroke();
    }
    function endAssistDraw() { assistDrawing = false; }

    if (assistCanvas && assistCtx) {
      assistCanvas.addEventListener("mousedown", startAssistDraw);
      assistCanvas.addEventListener("mousemove", drawAssist);
      assistCanvas.addEventListener("mouseup", endAssistDraw);
      assistCanvas.addEventListener("mouseleave", endAssistDraw);

      assistCanvas.addEventListener("touchstart", function(e){ e.preventDefault(); startAssistDraw(e);},{passive:false});
      assistCanvas.addEventListener("touchmove", function(e){ e.preventDefault(); drawAssist(e);},{passive:false});
      assistCanvas.addEventListener("touchend", function(e){ e.preventDefault(); endAssistDraw(e);},{passive:false});
    }

    function clearAssistSignature() {
      if (!assistCtx) return;
      assistCtx.clearRect(0, 0, assistCanvas.width, assistCanvas.height);
    }

    function loadAssistCase() {
      const labNo = document.getElementById("assistLabInput").value.trim().toLowerCase();
      if (!labNo) {
        alert("Ø§ÙƒØªØ¨ÙŠ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ù…Ù„.");
        return;
      }
      const c = cases.find(c => c.labNumber.toLowerCase() === labNo);
      if (!c) {
        alert("Ù…Ø§ ÙˆØ¬Ø¯Ù†Ø§ Ø­Ø§Ù„Ø© Ø¨Ù‡Ø°Ø§ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ù…Ù„.");
        return;
      }
      currentAssistCaseId = c.id;
      const sum = document.getElementById("assistSummary");
      sum.innerHTML = `
        <div><span class="tag green">Clinic Receive</span></div>
        <div>Ø§Ù„Ù…Ø±ÙŠØ¶ / Patient: <strong>${c.patientName}</strong></div>
        <div>File: ${c.fileNumber} â€¢ Lab: ${c.labNumber}</div>
        <div>Dept: ${c.caseType} â€¢ Tech: ${c.technician}</div>
        ${c.deliveryInfo ? `<div class="muted">Delivered from Lab: ${c.deliveryInfo.destination} at ${c.deliveryInfo.deliveredAt}</div>` : ""}
      `;
      document.getElementById("assistDetails").style.display = "block";
      document.getElementById("assistMsg").style.display = "none";
      clearAssistSignature();
    }

    function confirmAssistReceive() {
      if (currentAssistCaseId == null) {
        alert("Ø­Ù…Ù‘Ù„ÙŠ Ø§Ù„Ø­Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹.");
        return;
      }
      const idx = cases.findIndex(c => c.id === currentAssistCaseId);
      if (idx === -1) return;
      const now = new Date();
      const receivedAt = now.toLocaleString("ar-SA", { dateStyle:"short", timeStyle:"short" });

      cases[idx].assistantInfo = { receivedAt };
      cases[idx].phase = "Received by Clinic Assistant";
      cases[idx].status = "CLINIC_RECEIVED";
      saveJSON("dsa_cases", cases);
      document.getElementById("assistMsg").style.display = "block";
      alert("ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©ØŒ ÙŠØ¹Ø·ÙŠÙƒ Ø§Ù„Ø¹Ø§ÙÙŠØ© ÙŠØ§ Ø¨Ø·Ù„Ø© ğŸ’š");
    }

    // ===== STATS =====
    function openStatsPin() {
      document.getElementById("statsPinInput").value = "";
      document.getElementById("statsPinError").style.display = "none";
      showView("statsPinPage");
    }

    function checkStatsPin() {
      const val = document.getElementById("statsPinInput").value.trim();
      if (val === STATS_PIN) {
        document.getElementById("statsPinError").style.display = "none";
        renderStats();
        showView("statsPage");
      } else {
        document.getElementById("statsPinError").style.display = "block";
      }
    }

    function renderStats() {
      cases = loadJSON("dsa_cases", []);
      const total = cases.length;
      const inClinic  = cases.filter(c => c.status === "IN_CLINIC").length;
      const inLab     = cases.filter(c => c.status === "IN_LAB").length;
      const delivered = cases.filter(c => c.status === "DELIVERED").length;
      const clinicRec = cases.filter(c => c.status === "CLINIC_RECEIVED").length;

      const byDept = {};
      cases.forEach(c => {
        const k = c.caseType || "OTHER";
        byDept[k] = (byDept[k] || 0) + 1;
      });

      let html = "";
      html += `<div class="stats-row"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª / Total</span><strong>${total}</strong></div>`;
      html += `<div class="stats-row"><span>ÙÙŠ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© / In Clinic</span><strong>${inClinic}</strong></div>`;
      html += `<div class="stats-row"><span>ÙÙŠ Ø§Ù„Ù…Ø¹Ù…Ù„ / In Lab</span><strong>${inLab}</strong></div>`;
      html += `<div class="stats-row"><span>ØªÙ… ØªØ³Ù„ÙŠÙ…Ù‡Ø§ Ù…Ù† Ø§Ù„Ù…Ø¹Ù…Ù„ / Delivered</span><strong>${delivered}</strong></div>`;
      html += `<div class="stats-row"><span>Ø§Ø³ØªÙ„Ù…ØªÙ‡Ø§ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© / Clinic Received</span><strong>${clinicRec}</strong></div>`;
      html += `<hr style="margin:8px 0;border:none;border-top:1px solid #e5e7eb;">`;
      html += `<div class="muted" style="margin-bottom:4px;">ØªÙˆØ²ÙŠØ¹ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„Ø© / By case type:</div>`;
      Object.keys(byDept).forEach(k => {
        const val = byDept[k];
        const width = Math.min(100, (val / (total || 1)) * 100);
        html += `
          <div class="stats-row"><span>${k}</span><strong>${val}</strong></div>
          <div class="bar"><div class="bar-fill" style="width:${width}%;"></div></div>
        `;
      });

      document.getElementById("statsContent").innerHTML = html;
    }

    // ===== SETTINGS FAB + PANEL =====
    function openSettingsPin() {
      const pin = prompt("Ø£Ø¯Ø®Ù„ÙŠ Ø±Ù‚Ù… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… / Settings PIN:");
      if (pin === SETTINGS_PIN) {
        renderTechSettings();
        renderRejectedList();
        document.getElementById("settingsOverlay").classList.remove("hidden");
      } else if (pin !== null) {
        alert("Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­.");
      }
    }

    function closeSettingsOverlay(e) {
      // Ù„Ùˆ Ø¶ØºØ· Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¨Ø§Ù†Ù„
      if (e.target.id === "settingsOverlay") {
        closeSettingsPanel();
      }
    }

    function closeSettingsPanel() {
      document.getElementById("settingsOverlay").classList.add("hidden");
    }

    function renderTechSettings() {
      const container = document.getElementById("techSettingsContainer");
      if (!container) return;
      let html = "";
      Object.keys(techniciansByDept).forEach(dept => {
        const list = techniciansByDept[dept];
        if (!list.length) return;
        html += `<div style="margin-top:6px;font-weight:600;">Ø§Ù„Ù‚Ø³Ù… / Dept: ${dept}</div>`;
        list.forEach(name => {
          const st = getTechStatus(name);
          html += `
            <div class="settings-row">
              <span>${name}</span>
              <select class="small-select" data-tech="${name}">
                <option value="Active" ${st==="Active"?"selected":""}>Active</option>
                <option value="Leave" ${st==="Leave"?"selected":""}>On Leave</option>
                <option value="Inactive" ${st==="Inactive"?"selected":""}>Inactive</option>
              </select>
            </div>
          `;
        });
      });
      container.innerHTML = html || "<div class='muted'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ†ÙŠÙŠÙ†.</div>";
    }

    function saveTechSettings() {
      const selects = document.querySelectorAll('select[data-tech]');
      selects.forEach(sel => {
        const name = sel.getAttribute("data-tech");
        techStatus[name] = sel.value;
      });
      saveJSON("dsa_techStatus", techStatus);
      alert("ØªÙ… Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ÙÙ†ÙŠÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­ ğŸ’š");
    }

    // ===== INIT =====
    renderRejectedList();
  </script>
</body>
</html>
