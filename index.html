<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>DSA CONNECT â€“ Dental Lab Tracking System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    /* ğŸ¨ Ù‡ÙˆÙŠØ© Ø§Ù„Ø£Ù„ÙˆØ§Ù† */
    :root {
      --green-light: #A9D5B3;
      --green: #3CB371;
      --green-dark: #1B4630;

      --blue-light: #4FA3FF;
      --blue-dark: #2C5282;

      --purple-light: #8B68FF;
      --purple: #5A3CC9;

      --gold: #F0A73E;
      --gold-dark: #E68A21;

      --text: #222222;
      --gray: #DDDDDD;
      --white: #FFFFFF;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background: #f4f6f7;
      color: var(--text);
      direction: rtl;
    }

    h1, h2, h3 {
      margin-top: 0;
    }

    /* Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
    #loginPage {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, var(--green-light), var(--blue-light));
      padding: 16px;
    }

    .login-box {
      background: var(--white);
      padding: 24px;
      border-radius: 16px;
      max-width: 380px;
      width: 100%;
      box-shadow: 0 6px 20px rgba(0,0,0,0.15);
      text-align: center;
    }

    .login-box h1 {
      font-size: 1.4rem;
      margin-bottom: 6px;
    }

    .login-sub {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 18px;
    }

    .login-input {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      text-align: center;
      font-size: 1rem;
    }

    .login-btn {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: none;
      background: var(--green);
      color: var(--white);
      font-size: 1rem;
      cursor: pointer;
    }

    .login-btn:hover {
      background: var(--green-dark);
    }

    /* Ø¥Ø·Ø§Ø± Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
    #app {
      display: none;
      min-height: 100vh;
    }

    header {
      background: var(--green-dark);
      color: var(--white);
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .app-title {
      font-weight: 700;
      font-size: 1rem;
    }

    .app-subtitle {
      font-size: 0.8rem;
      opacity: 0.85;
    }

    .user-label {
      font-size: 0.8rem;
      opacity: 0.9;
    }

    /* Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµØºÙŠØ± (Ø¨Ø±Ù‚Ù… Ø³Ø±ÙŠ) */
    #settingsBtn {
      position: fixed;
      left: 15px;
      top: 64px;
      background: var(--green-light);
      width: 42px;
      height: 42px;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 22px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 50;
    }

    /* Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„ PIN Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª */
    #settingsModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 60;
    }

    .modal-box {
      background: var(--white);
      padding: 20px;
      border-radius: 14px;
      width: 280px;
      text-align: center;
      box-shadow: 0 4px 14px rgba(0,0,0,0.2);
    }

    /* Ù„ÙˆØ­Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ø³ÙŠØ·Ø© */
    #settingsPanel {
      position: fixed;
      left: -260px;
      top: 0;
      width: 260px;
      height: 100%;
      background: var(--white);
      box-shadow: 4px 0 12px rgba(0,0,0,0.2);
      padding: 16px;
      transition: 0.3s;
      z-index: 55;
      overflow-y: auto;
    }

    #settingsPanel h3 {
      margin-top: 0;
    }

    /* Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ */
    main {
      padding: 16px;
      padding-bottom: 80px;
    }

    .page {
      display: none;
    }

    /* Ø¨Ø·Ø§Ù‚Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… */
    .dashboard {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 10px;
    }

    .dash-card {
      background: var(--white);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 3px 12px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: 0.25s ease;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      border: 1px solid #e8e8e8;
    }

    .dash-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.14);
      background: #f6faf7;
    }

    .dash-icon {
      font-size: 30px;
      margin-bottom: 10px;
    }

    .dash-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: #1c3b34;
    }

    .dash-sub {
      font-size: 0.85rem;
      color: #6c857f;
      margin-top: 4px;
    }

    /* Ù†Ù…Ø§Ø°Ø¬ */
    .form-box {
      background: var(--white);
      padding: 18px;
      border-radius: 14px;
      box-shadow: 0 3px 12px rgba(0,0,0,0.08);
      max-width: 650px;
      margin: 0 auto;
      border: 1px solid #e8e8e8;
    }

    .input-row {
      margin-bottom: 10px;
    }

    .input-row label {
      font-weight: 600;
      margin-bottom: 4px;
      display: block;
      font-size: 0.9rem;
    }

    .input-row input,
    .input-row select,
    .input-row textarea {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
    }

    .input-row textarea {
      resize: vertical;
    }

    .submit-btn,
    .assist-btn {
      background: var(--green);
      color: var(--white);
      padding: 12px 18px;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      width: 100%;
      margin-top: 10px;
      cursor: pointer;
      transition: 0.3s;
    }

    .submit-btn:hover,
    .assist-btn:hover {
      background: var(--green-dark);
    }

    /* ØµÙ†Ø§Ø¯ÙŠÙ‚ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª */
    .case-info,
    .assist-info {
      background: #f6faf7;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #dce8e1;
      margin-bottom: 12px;
      font-size: 0.9rem;
    }

    .sign-input {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    /* Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
    .stats-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 10px 0;
    }

    .stat-card {
      background: white;
      padding: 16px;
      border-radius: 14px;
      box-shadow: 0 3px 12px rgba(0,0,0,0.07);
      border: 1px solid #e8e8e8;
      margin-bottom: 12px;
    }

    .stat-title {
      font-size: 1.05rem;
      font-weight: 700;
      margin-bottom: 4px;
      color: #1c3b34;
    }

    .stat-number {
      font-size: 1.4rem;
      font-weight: 800;
      color: #197a57;
    }

    .bar {
      width: 100%;
      height: 10px;
      background: #e8e8e8;
      border-radius: 6px;
      overflow: hidden;
      margin-top: 8px;
    }

    .bar-fill {
      height: 100%;
      border-radius: 6px;
      transition: 0.4s ease;
    }

    /* Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¶Ø© */
    .reject-box {
      background: white;
      padding: 18px;
      border-radius: 16px;
      box-shadow: 0 3px 12px rgba(0,0,0,0.08);
      max-width: 650px;
      margin: 0 auto;
      border: 1px solid #e8e8e8;
    }

    .reject-item {
      background: #fff4f4;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ffcccc;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    /* ØµÙØ­Ø© Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ø¨Ø³ÙŠØ·Ø© */
    .tech-cards {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .tcard {
      padding: 14px;
      border-radius: 14px;
      color: white;
      font-weight: bold;
      box-shadow: 0 3px 12px rgba(0,0,0,0.12);
      text-align: center;
      font-size: 0.95rem;
    }

    .tcard.green { background: var(--green); }
    .tcard.blue { background: var(--blue-light); }
    .tcard.purple { background: var(--purple-light); }
    .tcard.orange { background: var(--gold); }

    .tech-case-card {
      padding: 12px;
      background: var(--white);
      border-radius: 12px;
      margin-bottom: 10px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
      border-right: 6px solid var(--green-light);
      font-size: 0.9rem;
    }

    /* ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ + ØªØ¨ÙˆÙŠØ¨Ø§Øª ØªØ­Øª */
    #techTabs {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: var(--white);
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      border-top: 2px solid var(--gray);
      padding: 4px 0;
      box-shadow: 0 -4px 10px rgba(0,0,0,0.1);
    }

    .tab-btn {
      text-align: center;
      font-size: 0.7rem;
      padding: 4px;
      color: var(--text);
      cursor: pointer;
    }

    .tab-btn:hover {
      background: var(--green-light);
      color: var(--green-dark);
    }

    .tab-section {
      display: none;
      padding: 12px;
      margin-bottom: 76px;
      animation: fade 0.3s;
      font-size: 0.9rem;
    }

    .active-tab {
      display: block !important;
    }

    @keyframes fade {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    footer {
      text-align: center;
      font-size: 0.75rem;
      color: #777;
      padding: 10px;
      margin-top: 10px;
    }

    @media (max-width: 600px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 4px;
      }
      .tech-cards {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>
</head>
<body>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="loginPage">
  <div class="login-box">
    <h1>DSA CONNECT</h1>
    <div class="login-sub">Dental Lab Tracking â€“ ØªØªØ¨Ù‘Ø¹ Ø°ÙƒÙŠ Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø¹Ù…Ù„</div>
    <p>âœ¨ Ø£Ù‡Ù„Ø§Ù‹ØŒ Ø¬Ø§Ù‡Ø²Ø© Ù†Ø±ØªØ¨ ÙŠÙˆÙ…Ùƒ ÙˆÙ†Ù…Ø³Ùƒ ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø¨Ø¯ÙˆÙ† Ù…Ø§ ØªØ¶ÙŠØ¹ØŸ</p>
    <input id="loginUser" class="login-input" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… / Username">
    <input id="loginPin" class="login-input" type="password" placeholder="Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ / PIN">
    <button class="login-btn" onclick="login()">Ø¯Ø®ÙˆÙ„ / Login</button>
  </div>
</div>

<!-- Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
<div id="app">
  <header>
    <div>
      <div class="app-title">DSA CONNECT â€“ Dental Lab System</div>
      <div class="app-subtitle">Ù…Ù† Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¹Ù…Ù„â€¦ ØªØ¯ÙÙ‘Ù‚ ÙˆØ§Ø­Ø¯ ÙˆØ§Ø¶Ø­ ğŸ’š</div>
    </div>
    <div class="user-label" id="userLabel"></div>
  </header>

  <!-- Ø²Ø± Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ø±Ù‚Ù… Ø³Ø±ÙŠ ØµØºÙŠØ± -->
  <div id="settingsBtn" onclick="openSettingsPIN()">âš™ï¸</div>

  <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø®Ø§Ù„ PIN Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
  <div id="settingsModal">
    <div class="modal-box">
      <h3>ğŸ” Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ±</h3>
      <p>Ø£Ø¯Ø®Ù„ÙŠ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ù„ÙØªØ­ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</p>
      <input id="settingsPIN" class="login-input" type="password" placeholder="Manager PIN">
      <button class="login-btn" onclick="checkSettingsPIN()">Ø¯Ø®ÙˆÙ„</button>
    </div>
  </div>

  <!-- Ù„ÙˆØ­Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ø³ÙŠØ·Ø© -->
  <div id="settingsPanel">
    <h3>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª DSA CONNECT</h3>
    <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙˆØ¯Ø§Ø¯ ğŸ¤<br>Ù‡Ù†Ø§ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø®Ø§ØµØ© ÙÙŠÙƒ.</p>
    <hr>
    <h4>ğŸ”‘ ØªØºÙŠÙŠØ± Ø±Ù‚Ù… PIN Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø­Ø§Ù„ÙŠØ§Ù‹: 9999)</h4>
    <input id="newManagerPIN" class="login-input" type="password" placeholder="PIN Ø¬Ø¯ÙŠØ¯">
    <button class="login-btn" onclick="changeManagerPIN()">Ø­ÙØ¸ PIN Ø¬Ø¯ÙŠØ¯</button>
    <hr>
    <h4>ğŸ’¾ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ (Download JSON)</h4>
    <button class="login-btn" onclick="backupData()">ØªÙ†Ø²ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø§Øª</button>
    <p style="font-size:0.8rem;color:#666;">* Ù‡Ø°Ù‡ Ù†Ø³Ø®Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù…Ø­Ù„ÙŠØ© â€“ ØªØ­ØªØ§Ø¬ Back-End Ø­Ù‚ÙŠÙ‚ÙŠ ÙÙŠ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.</p>
  </div>

  <main>
    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
    <div id="dashboard" class="page">
      <h2>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… / Dashboard</h2>
      <p>âœ¨ "ÙƒÙ„ Ø­Ø§Ù„Ø© ÙˆØ§Ø¶Ø­Ø©ØŒ ÙˆÙƒÙ„ Ø®Ø·ÙˆØ© Ù…Ø­Ø³ÙˆØ¨Ø©" â€“ ÙŠÙ„Ø§ Ù†Ø´ØªØºÙ„ Ø¨Ù‡Ø¯ÙˆØ¡ ÙˆÙ‚ÙˆØ©.</p>

      <div class="dashboard">
        <div class="dash-card" onclick="openPage('clinicEntry')">
          <div class="dash-icon">ğŸ“</div>
          <div class="dash-title">ØªØ³Ø¬ÙŠÙ„ Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</div>
          <div class="dash-sub">New Case Entry â€“ Ù…Ù† Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ù„Ù„Ù…Ø¹Ù…Ù„</div>
        </div>

        <div class="dash-card" onclick="openPage('labReceive')">
          <div class="dash-icon">ğŸ­</div>
          <div class="dash-title">Ø§Ø³ØªÙ„Ø§Ù… Ù…Ù† Ø§Ù„Ù…Ø¹Ù…Ù„</div>
          <div class="dash-sub">Lab Receiving â€“ ØªØ³Ø¬ÙŠÙ„ ÙˆØµÙˆÙ„ + ÙˆÙ‚Øª Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</div>
        </div>

        <div class="dash-card" onclick="openPage('techToDept')">
          <div class="dash-icon">ğŸ‘¨ğŸ»â€ğŸ”§</div>
          <div class="dash-title">ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ â†’ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
          <div class="dash-sub">RDC1 / RDC2 / Box / Clinic</div>
        </div>

        <div class="dash-card" onclick="openPage('assistantReceive')">
          <div class="dash-icon">ğŸ“¦</div>
          <div class="dash-title">Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©</div>
          <div class="dash-sub">Scan + ØªÙˆÙ‚ÙŠØ¹ + Ø¹Ø¨Ø§Ø±Ø© ØªØ­ÙÙŠØ²ÙŠØ©</div>
        </div>

        <div class="dash-card" onclick="openStats()">
          <div class="dash-icon">ğŸ“Š</div>
          <div class="dash-title">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>
          <div class="dash-sub">Royal Statistics â€“ Ø¥Ù†ØªØ§Ø¬ÙŠØ© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>
        </div>

        <div class="dash-card" onclick="openPage('rejectedCases')">
          <div class="dash-icon">ğŸ—‚</div>
          <div class="dash-title">Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¶Ø©</div>
          <div class="dash-sub">Rejected Cases â€“ Ù…Ù†Ø¹ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø®Ø§Ø·Ø¦Ø©</div>
        </div>

        <div class="dash-card" onclick="openPage('searchCase')">
          <div class="dash-icon">ğŸ”</div>
          <div class="dash-title">Ø¨Ø­Ø« Ø¹Ù† Ø­Ø§Ù„Ø©</div>
          <div class="dash-sub">File / Name / LabNumber</div>
        </div>

        <div class="dash-card" onclick="openPage('techDashboard')">
          <div class="dash-icon">ğŸ§‘ğŸ»â€ğŸ”§</div>
          <div class="dash-title">Ù„ÙˆØ­Ø© Ø§Ù„ÙÙ†ÙŠ (ØªØ¬Ø±ÙŠØ¨ÙŠØ©)</div>
          <div class="dash-sub">Overview Ø³Ø±ÙŠØ¹ Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„ÙÙ†ÙŠ</div>
        </div>
      </div>
    </div>

    <!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© -->
    <div id="clinicEntry" class="page">
      <h2>ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© / New Case Entry</h2>
      <div class="form-box">
        <div class="input-row">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù / File Number</label>
          <input id="fileNumber" type="text">
        </div>

        <div class="input-row">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ / Patient Name</label>
          <input id="patientName" type="text">
        </div>

        <div class="input-row">
          <label>Ø±Ù‚Ù… Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© / Clinic Number</label>
          <input id="clinicNumber" type="text">
        </div>

        <div class="input-row">
          <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨ / Doctor Name</label>
          <input id="doctorName" type="text">
        </div>

        <div class="input-row">
          <label>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„Ø© / Case Type</label>
          <select id="caseType">
            <option value="RPD">RPD</option>
            <option value="CD">CD</option>
            <option value="PFM">Crown / PFM</option>
            <option value="ORTHO">Ortho</option>
            <option value="TM">TM</option>
          </select>
        </div>

        <div class="input-row">
          <label>Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù…Ø±ÙŠØ¶ Ø§Ù„Ù‚Ø§Ø¯Ù… / Next Appointment</label>
          <input id="nextAppointment" type="date">
        </div>

        <div class="input-row">
          <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨ / Doctor Notes</label>
          <textarea id="doctorNotes" rows="2" placeholder="Ù…Ø«Ø§Ù„: Ø±Ø§Ø¬Ø¹Ù†Ø§ occlusion / Ø§Ù†ØªØ¨Ø§Ù‡ Ù„Ù„Ù€ shade"></textarea>
        </div>

        <div class="input-row">
          <label>ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨ / Doctor Request</label>
          <textarea id="doctorRequest" rows="2" placeholder="Ù…Ø«Ø§Ù„: Metal try-in, reline, repair, shade A3 ..."></textarea>
        </div>

        <div class="input-row">
          <label>ØµÙˆØ± Ø§Ù„Ø­Ø§Ù„Ø© (Ø£Ø´Ø¹Ø© + ÙÙ… + Ø·Ù„Ø¨ Ø§Ù„Ø·Ø¨ÙŠØ¨) / Case Images</label>
          <input id="caseImages" type="file" accept="image/*" multiple>
          <small>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± Ø£ÙƒØ«Ø± Ù…Ù† ØµÙˆØ±Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©.</small>
        </div>

        <button class="submit-btn" onclick="saveClinicEntry()">Ø­ÙØ¸ / Save</button>
      </div>
    </div>

    <!-- Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù…Ø¹Ù…Ù„ -->
    <div id="labReceive" class="page">
      <h2>ğŸ­ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù…Ø¹Ù…Ù„ / Lab Receiving</h2>
      <div class="form-box">
        <div class="input-row">
          <label>ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù / Search by File Number</label>
          <input id="labReceiveSearch" type="text" onkeyup="findCaseForLab()">
        </div>
        <div id="labReceiveResult"></div>
      </div>
    </div>

    <!-- ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… -->
    <div id="techToDept" class="page">
      <h2>ğŸ‘¨ğŸ»â€ğŸ”§ ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ â†’ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… / Technician Transfer</h2>
      <div class="form-box">
        <div class="input-row">
          <label>ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ù…Ù„ / Search by Lab Number</label>
          <input id="techSearch" type="text" onkeyup="findCaseForTech()">
        </div>
        <div id="techResult"></div>
      </div>
    </div>

    <!-- Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© -->
    <div id="assistantReceive" class="page">
      <h2>ğŸ“¦ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© / Assistant Receive</h2>
      <div class="form-box">
        <div class="input-row">
          <label>ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù Ø£Ùˆ Ø§Ù„Ù…Ø¹Ù…Ù„ / File or Lab Number</label>
          <input id="assistSearch" type="text" class="sign-input" onkeyup="findCaseForAssistant()">
        </div>
        <div id="assistResult"></div>
      </div>
    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
    <div id="statsPage" class="page">
      <h2>ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ù„ÙƒÙŠØ© / Royal Statistics</h2>
      <div class="stats-container">
        <div id="statsContent"></div>
      </div>
    </div>

    <!-- Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¶Ø© -->
    <div id="rejectedCases" class="page">
      <h2>ğŸ—‚ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¶Ø© / Rejected Cases</h2>
      <div class="reject-box">
        <h3>â• Ø¥Ø¶Ø§ÙØ© Ø­Ø§Ù„Ø© Ù…Ø±ÙÙˆØ¶Ø©</h3>
        <div class="input-row">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù / File Number</label>
          <input id="rejFile" class="sign-input" type="text">
        </div>
        <div class="input-row">
          <label>Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶ / Reason</label>
          <input id="rejReason" class="sign-input" type="text">
        </div>
        <button class="assist-btn" onclick="addRejectedCase()">Ø¥Ø¶Ø§ÙØ© / Add</button>

        <hr style="margin:14px 0;">

        <h3>ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø­Ø§Ù„Ø© Ù…Ø±ÙÙˆØ¶Ø©</h3>
        <input id="searchRejected" class="sign-input" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù" onkeyup="findRejected()">
        <div id="rejectedList" style="margin-top:10px;"></div>
      </div>
    </div>

    <!-- Ø¨Ø­Ø« Ø¹Ù† Ø­Ø§Ù„Ø© -->
    <div id="searchCase" class="page">
      <h2>ğŸ” Ø¨Ø­Ø« Ø¹Ù† Ø­Ø§Ù„Ø© / Search Case</h2>
      <div class="form-box">
        <input id="searchInput" class="sign-input" type="text" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ù…Ù„Ù Ø£Ùˆ Ø§Ø³Ù… Ø£Ùˆ Lab Number" onkeyup="searchCaseNow()">
        <div id="searchResult" style="margin-top:10px;"></div>
      </div>
    </div>

    <!-- Ù„ÙˆØ­Ø© ÙÙ†ÙŠ Ø¨Ø³ÙŠØ·Ø© -->
    <div id="techDashboard" class="page">
      <h2>ğŸ§‘ğŸ»â€ğŸ”§ Ù„ÙˆØ­Ø© Ø§Ù„ÙÙ†ÙŠ (ØªØ¬Ø±ÙŠØ¨ÙŠØ©)</h2>
      <p>ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙƒØ¹Ø±Ø¶ Ø³Ø±ÙŠØ¹ Ù„Ø­Ø§Ù„Ø§Øª ÙÙ†ÙŠ Ù…Ø¹ÙŠÙ‘Ù†.</p>
      <div class="input-row">
        <label>Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ / Technician Name</label>
        <input id="techNameInput" class="sign-input" type="text" placeholder="Ù…Ø«Ø§Ù„: Turki O" onkeyup="loadTechCases()">
      </div>
      <div class="tech-cards">
        <div class="tcard green">ğŸ“¦ Total <span id="techTotal"></span></div>
        <div class="tcard blue">ğŸ•’ Today <span id="techToday"></span></div>
        <div class="tcard purple">âœ” Done <span id="techDone"></span></div>
        <div class="tcard orange">â†© Returned <span id="techReturned"></span></div>
      </div>
      <div id="techCaseList"></div>
    </div>

    <!-- ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ + ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
    <div id="techDetails" class="page" style="display:none;">
      <h2>ğŸ”§ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© / Case Details</h2>
      <div id="techDetailsHeader" class="case-info"></div>

      <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª ØªØ­Øª -->
      <div id="techTabs">
        <div class="tab-btn" onclick="openTechTab('infoTab')">ğŸ“„ Info</div>
        <div class="tab-btn" onclick="openTechTab('notesTab')">ğŸ“ Notes</div>
        <div class="tab-btn" onclick="openTechTab('requestTab')">ğŸ“˜ Request</div>
        <div class="tab-btn" onclick="openTechTab('imagesTab')">ğŸ–¼ Images</div>
        <div class="tab-btn" onclick="openTechTab('trackTab')">ğŸ“Š Track</div>
        <div class="tab-btn" onclick="openTechTab('r4Tab')">ğŸ”— R4</div>
        <div class="tab-btn" onclick="openTechTab('actionsTab')">âš™ï¸ Actions</div>
      </div>

      <div id="infoTab" class="tab-section"></div>
      <div id="notesTab" class="tab-section"></div>
      <div id="requestTab" class="tab-section"></div>
      <div id="imagesTab" class="tab-section"></div>
      <div id="trackTab" class="tab-section"></div>
      <div id="r4Tab" class="tab-section"></div>
      <div id="actionsTab" class="tab-section"></div>
    </div>

    <footer>
      Â© 2025 Wedad Aljabari â€“ All Rights Reserved  
      DSA CONNECT â€“ Designed with ğŸ’š for DSA Lab.
    </footer>
  </main>
</div>

<script>
  // PIN Ø§Ù„Ù…Ø¯ÙŠØ± Ù„Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
  let managerPIN = "9999";
  let currentUser = "";

  function login() {
    const user = document.getElementById("loginUser").value.trim();
    const pin = document.getElementById("loginPin").value.trim();
    if (!user || !pin) {
      alert("âš  Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ");
      return;
    }
    // Ù…Ø¤Ù‚ØªØ§Ù‹ Ø£ÙŠ Ù…Ø³ØªØ®Ø¯Ù… + Ø£ÙŠ PIN ÙŠØ¹ØªØ¨Ø± Ø¯Ø®ÙˆÙ„ Ù†Ø§Ø¬Ø­
    currentUser = user;
    document.getElementById("userLabel").innerText = "Ù…Ø±Ø­Ø¨Ø§Ù‹ " + currentUser + " ğŸ¤";
    document.getElementById("loginPage").style.display = "none";
    document.getElementById("app").style.display = "block";
    openPage("dashboard");
  }

  function openPage(id) {
    document.querySelectorAll(".page").forEach(p => p.style.display = "none");
    const el = document.getElementById(id);
    if (el) el.style.display = "block";
    if (id === "statsPage") renderStats();
  }

  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¯ÙŠØ±
  function openSettingsPIN() {
    document.getElementById("settingsModal").style.display = "flex";
  }

  function checkSettingsPIN() {
    const pin = document.getElementById("settingsPIN").value.trim();
    if (pin === managerPIN) {
      document.getElementById("settingsModal").style.display = "none";
      document.getElementById("settingsPanel").style.left = "0";
    } else {
      alert("âŒ Ø±Ù‚Ù… PIN ØºÙŠØ± ØµØ­ÙŠØ­");
    }
  }

  function changeManagerPIN() {
    const newPin = document.getElementById("newManagerPIN").value.trim();
    if (!newPin) {
      alert("âš  Ø£Ø¯Ø®Ù„ÙŠ PIN Ø¬Ø¯ÙŠØ¯");
      return;
    }
    managerPIN = newPin;
    alert("âœ” ØªÙ… ØªØºÙŠÙŠØ± PIN Ø§Ù„Ù…Ø¯ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­");
  }

  function backupData() {
    const cases = localStorage.getItem("dsa_cases") || "[]";
    const blob = new Blob([cases], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "dsa_connect_cases_backup.json";
    a.click();
    URL.revokeObjectURL(url);
  }

  // Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©
  function saveClinicEntry() {
    let filesInput = document.getElementById("caseImages");
    let images = [];

    if (filesInput && filesInput.files && filesInput.files.length > 0) {
      for (let i = 0; i < filesInput.files.length; i++) {
        const file = filesInput.files[i];
        const url = URL.createObjectURL(file);
        images.push({
          name: file.name,
          url: url
        });
      }
    }

    let caseObj = {
      id: Date.now(),
      file: document.getElementById("fileNumber").value.trim(),
      name: document.getElementById("patientName").value.trim(),
      clinic: document.getElementById("clinicNumber").value.trim(),
      doctor: document.getElementById("doctorName").value.trim(),
      type: document.getElementById("caseType").value,
      next: document.getElementById("nextAppointment").value,
      status: "ENTERED_CLINIC",
      deptKey: document.getElementById("caseType").value,
      labNumber: "LAB-" + Math.floor(10000 + Math.random() * 90000),
      time: new Date().toLocaleString(),
      doctorNotes: document.getElementById("doctorNotes").value.trim(),
      doctorRequest: document.getElementById("doctorRequest").value.trim(),
      images: images,
      assignedTech: ""
    };

    if (!caseObj.file || !caseObj.name || !caseObj.clinic || !caseObj.doctor || !caseObj.type) {
      alert("âš  Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ù…Ù„ÙØŒ Ø§Ø³Ù…ØŒ Ø¹ÙŠØ§Ø¯Ø©ØŒ Ø·Ø¨ÙŠØ¨ØŒ Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„Ø©).");
      return;
    }

    let cases = JSON.parse(localStorage.getItem("dsa_cases") || "[]");
    cases.push(caseObj);
    localStorage.setItem("dsa_cases", JSON.stringify(cases));

    alert("âœ” ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!\nâœ” Case saved successfully!");
    openPage("dashboard");
  }

  // Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ø¹Ù…Ù„
  function findCaseForLab() {
    const file = document.getElementById("labReceiveSearch").value.trim();
    const cases = JSON.parse(localStorage.getItem("dsa_cases") || "[]");
    const found = cases.find(c => c.file === file);
    const target = document.getElementById("labReceiveResult");

    if (!found) {
      target.innerHTML = "<p style='margin-top:8px;color:#888;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…</p>";
      return;
    }

    target.innerHTML = `
      <div class="case-info">
        <b>Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù:</b> ${found.file}<br>
        <b>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶:</b> ${found.name}<br>
        <b>Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©:</b> ${found.clinic}<br>
        <b>Ø§Ù„Ø·Ø¨ÙŠØ¨:</b> ${found.doctor}<br>
        <b>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„Ø©:</b> ${found.type}<br>
        <b>Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ù…Ù„:</b> ${found.labNumber}<br>
        <b>ÙˆÙ‚Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</b> ${found.time}<br>
        ${found.doctorNotes ? `<b>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨:</b> ${found.doctorNotes}<br>` : ""}
        ${found.doctorRequest ? `<b>ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨:</b> ${found.doctorRequest}<br>` : ""}
      </div>

      ${
        found.images && found.images.length
        ? `<div style="margin-bottom:10px;">
            <b>ØµÙˆØ± Ø§Ù„Ø­Ø§Ù„Ø©:</b><br>
            ${found.images.map(img => `
              <div style="margin-top:6px;">
                <img src="${img.url}" style="max-width:100%;border-radius:8px;border:1px solid #ddd;">
                <div style="font-size:0.8rem;color:#555;">${img.name}</div>
              </div>
            `).join("")}
          </div>`
        : `<p style="color:#777;">Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙˆØ± Ù…Ø±ÙÙˆØ¹Ø©</p>`
      }

      <button class="assist-btn" onclick="submitLabReceive('${found.id}')">
        âœ” ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ø¹Ù…Ù„ / Confirm Receive
      </button>
    `;
  }

  function submitLabReceive(caseId) {
    let cases = JSON.parse(localStorage.getItem("dsa_cases") || "[]");
    let target = cases.find(c => c.id == caseId);

    target.status = "IN_LAB";
    target.receiveTime = new Date().toLocaleString();

    localStorage.setItem("dsa_cases", JSON.stringify(cases));
    alert("âœ” ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù…Ø¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­!");
    openPage("dashboard");
  }

  // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
  function findCaseForTech() {
    const lab = document.getElementById("techSearch").value.trim();
    const cases = JSON.parse(localStorage.getItem("dsa_cases") || "[]");
    const found = cases.find(c => c.labNumber === lab);
    const target = document.getElementById("techResult");

    if (!found) {
      target.innerHTML = "<p style='margin-top:8px;color:#888;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø§Ù„Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…</p>";
      return;
    }

    target.innerHTML = `
      <div class="case-info">
        <b>Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù:</b> ${found.file}<br>
        <b>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶:</b> ${found.name}<br>
        <b>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„Ø©:</b> ${found.type}<br>
        <b>Ø§Ù„Ø·Ø¨ÙŠØ¨:</b> ${found.doctor}<br>
        <b>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</b> ${found.status}<br>
        <b>Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ù…Ù„:</b> ${found.labNumber}<br>
        <b>Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ:</b> ${found.assignedTech || "Ù„Ù… ÙŠØ­Ø¯Ø¯"}<br>
      </div>

      <div class="input-row">
        <label>Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù… / Select Department</label>
        <select id="deptSelect">
          <option value="RDC1">RDC1</option>
          <option value="RDC2">RDC2</option>
          <option value="BOX">Box</option>
          <option value="CLINIC">Clinic</option>
        </select>
      </div>

      <div class="input-row">
        <label>Ø§Ø³Ù… Ø§Ù„ÙÙ†ÙŠ / Technician</label>
        <input id="techAssign" type="text" placeholder="Ù…Ø«Ø§Ù„: Turki O">
      </div>

      <button class="assist-btn" onclick="submitTechTransfer('${found.id}')">
        âœ” ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© / Transfer Case
      </button>
    `;
  }

  function submitTechTransfer(caseId) {
    let cases = JSON.parse(localStorage.getItem("dsa_cases") || "[]");
    let target = cases.find(c => c.id == caseId);

    const dept = document.getElementById("deptSelect").value;
    const techName = document.getElementById("techAssign").value.trim();

    target.status = "READY_FOR_" + dept;
    target.transferTime = new Date().toLocaleString();
    if (techName) target.assignedTech = techName;

    localStorage.setItem("dsa_cases", JSON.stringify(cases));
    alert("âœ” ØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­!");
    openPage("dashboard");
  }

  // Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
  function findCaseForAssistant() {
    const val = document.getElementById("assistSearch").value.trim();
    const cases = JSON.parse(localStorage.getItem("dsa_cases") || "[]");
    const found = cases.find(c => c.file === val || c.labNumber === val);
    const target = document.getElementById("assistResult");

    if (!found) {
      target.innerHTML = "<p style='margin-top:8px;color:#888;'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ Ø­Ø§Ù„Ø©</p>";
      return;
    }

    target.innerHTML = `
      <div class="assist-info">
        <b>Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù:</b> ${found.file}<br>
        <b>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶:</b> ${found.name}<br>
        <b>Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</b> ${found.status}<br>
        <b>Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ù…Ù„:</b> ${found.labNumber}<br>
        ${found.doctorNotes ? `<b>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨:</b> ${found.doctorNotes}<br>` : ""}
        ${found.doctorRequest ? `<b>ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨:</b> ${found.doctorRequest}<br>` : ""}
      </div>

      ${
        found.images && found.images.length ? `
          <b>ØµÙˆØ± Ø§Ù„Ø­Ø§Ù„Ø©:</b><br>
          ${found.images.map(im => `
            <img src="${im.url}" style="max-width:100%;border-radius:8px;margin-top:4px;">
          `).join("")}
        ` : ""
      }

      <div class="input-row">
        <label>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© / Signature</label>
        <input id="assistSignature" type="text" class="sign-input" placeholder="Ø§ÙƒØªØ¨ÙŠ Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§">
      </div>

      <button class="assist-btn" onclick="submitAssistantReceive('${found.id}')">
        âœ” ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© / Confirm Clinic Receive
      </button>
    `;
  }

  function submitAssistantReceive(caseId) {
    let cases = JSON.parse(localStorage.getItem("dsa_cases") || "[]");
    let target = cases.find(c => c.id == caseId);

    const sign = document.getElementById("assistSignature").value.trim();
    if (!sign) {
      alert("âš  Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©");
      return;
    }

    target.status = "CLINIC_RECEIVED";
    target.assistantSign = sign;
    target.assistantTime = new Date().toLocaleString();

    localStorage.setItem("dsa_cases", JSON.stringify(cases));
    alert("ğŸ’š ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø­Ø§Ù„Ø©ØŒ ÙŠÙˆÙ…Ùƒ Ù…Ø¨Ø§Ø±Ùƒ ÙŠØ§ Ø¨Ø·Ù„Ø©!");
    openPage("dashboard");
  }

  // Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
  function openStats() {
    openPage("statsPage");
    renderStats();
  }

  function renderStats() {
    let cases = JSON.parse(localStorage.getItem("dsa_cases") || "[]");

    const total = cases.length;
    const inLab = cases.filter(c => c.status === "IN_LAB").length;
    const clinicReceived = cases.filter(c => c.status === "CLINIC_RECEIVED").length;
    const finished = clinicReceived;
    const returned = cases.filter(c => c.status === "RETURNED").length;

    let html = `
      <div class="stat-card">
        <div class="stat-title">ğŸ“¦ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª / Total Cases</div>
        <div class="stat-number">${total}</div>
      </div>

      <div class="stat-card">
        <div class="stat-title">ğŸ­ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¹Ù…Ù„ / In Lab</div>
        <div class="stat-number">${inLab}</div>
      </div>

      <div class="stat-card">
        <div class="stat-title">ğŸ“¨ Ù…ÙƒØªÙ…Ù„Ø© / Completed</div>
        <div class="stat-number">${finished}</div>
      </div>

      <div class="stat-card">
        <div class="stat-title">ğŸ”„ Ø±Ø§Ø¬Ø¹Ø© / Returned</div>
        <div class="stat-number">${returned}</div>
      </div>

      <hr style="margin:18px 0;">
      <h3>ğŸ¦· Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ø£Ù‚Ø³Ø§Ù… / Department Performance</h3>
    `;

    const deptColors = {
      RPD: "#ff7675",
      CD: "#74b9ff",
      PFM: "#ffeaa7",
      TM: "#55efc4",
      ORTHO: "#a29bfe"
    };

    const byDept = {};
    const completedDept = {};

    cases.forEach(c => {
      const d = c.deptKey;
      if (!d) return;
      byDept[d] = (byDept[d] || 0) + 1;
      if (c.status === "CLINIC_RECEIVED") {
        completedDept[d] = (completedDept[d] || 0) + 1;
      }
    });

    Object.keys(byDept).forEach(d => {
      const totalD = byDept[d];
      const doneD = completedDept[d] || 0;
      const percent = totalD ? Math.floor((doneD / totalD) * 100) : 0;
      html += `
        <div class="stat-card">
          <div class="stat-title">${d} Cases</div>
          <p><b>${doneD}</b> / ${totalD}</p>
          <div class="bar">
            <div class="bar-fill" style="width:${percent}%;background:${deptColors[d] || '#3CB371'};"></div>
          </div>
          <p style="font-size:0.9rem;margin-top:4px;">Percentage: ${percent}%</p>
        </div>
      `;
    });

    document.getElementById("statsContent").innerHTML = html;
  }

  // Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø±ÙÙˆØ¶Ø©
  function addRejectedCase() {
    const file = document.getElementById("rejFile").value.trim();
    const reason = document.getElementById("rejReason").value.trim();

    if (!file || !reason) {
      alert("âš  Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„");
      return;
    }

    let rej = JSON.parse(localStorage.getItem("rejected_cases") || "[]");
    rej.push({file, reason});
    localStorage.setItem("rejected_cases", JSON.stringify(rej));

    alert("âœ” ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙÙˆØ¶ÙŠÙ†");
    document.getElementById("rejFile").value = "";
    document.getElementById("rejReason").value = "";
    findRejected();
  }

  function findRejected() {
    const val = document.getElementById("searchRejected").value.trim();
    let rej = JSON.parse(localStorage.getItem("rejected_cases") || "[]");

    const found = rej.filter(r => r.file.includes(val));
    let html = "";
    found.forEach(r => {
      html += `
        <div class="reject-item">
          <b>Ù…Ù„Ù:</b> ${r.file}<br>
          <b>Ø³Ø¨Ø¨:</b> ${r.reason}
        </div>
      `;
    });
    document.getElementById("rejectedList").innerHTML = html;
  }

  // Ø¨Ø­Ø« Ø¹Ù† Ø­Ø§Ù„Ø©
  function searchCaseNow() {
    const val = document.getElementById("searchInput").value.trim().toLowerCase();
    let cases = JSON.parse(localStorage.getItem("dsa_cases") || "[]");

    const found = cases.filter(c =>
      c.file.toLowerCase().includes(val) ||
      c.name.toLowerCase().includes(val) ||
      c.labNumber.toLowerCase().includes(val)
    );

    let html = "";
    found.forEach(c => {
      html += `
        <div class="assist-info">
          <b>Ù…Ù„Ù:</b> ${c.file}<br>
          <b>Ø§Ø³Ù…:</b> ${c.name}<br>
          <b>Lab:</b> ${c.labNumber}<br>
          <b>Ø§Ù„Ù‚Ø³Ù…:</b> ${c.deptKey || "-" }<br>
          <b>Ø§Ù„Ø­Ø§Ù„Ø©:</b> ${c.status}<br>
          <b>Ø§Ù„ÙÙ†ÙŠ:</b> ${c.assignedTech || "â€”"}<br>
        </div>
      `;
    });

    document.getElementById("searchResult").innerHTML = html;
  }

  // Ù„ÙˆØ­Ø© Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ø¨Ø³ÙŠØ·Ø©
  function todayDate() {
    const d = new Date();
    return d.toLocaleDateString();
  }

  function loadTechCases() {
    const techName = document.getElementById("techNameInput").value.trim();
    let list = JSON.parse(localStorage.getItem("dsa_cases") || "[]");
    let myCases = techName ? list.filter(c => (c.assignedTech || "").toLowerCase().includes(techName.toLowerCase())) : [];

    document.getElementById("techTotal").innerText = myCases.length;
    document.getElementById("techToday").innerText = myCases.filter(c => (c.time || "").includes(todayDate())).length;
    document.getElementById("techDone").innerText = myCases.filter(c => c.status === "CLINIC_RECEIVED").length;
    document.getElementById("techReturned").innerText = myCases.filter(c => c.status === "RETURNED").length;

    let html = "";
    myCases.forEach(c => {
      html += `
        <div class="tech-case-card">
          <b>${c.name}</b> â€” ${c.type}<br>
          Ù…Ù„Ù: ${c.file}<br>
          Lab: ${c.labNumber}<br>
          Ø­Ø§Ù„Ø©: ${c.status}<br>
          <button class="assist-btn" onclick="openTechDetails('${c.id}')">ØªÙØ§ØµÙŠÙ„ / Details</button>
        </div>
      `;
    });

    document.getElementById("techCaseList").innerHTML = html;
  }

  // ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙÙ†ÙŠ + ØªØ¨ÙˆÙŠØ¨Ø§Øª
  let currentTechCase = null;

  function openTechDetails(caseId) {
    let list = JSON.parse(localStorage.getItem("dsa_cases") || "[]");
    currentTechCase = list.find(c => c.id == caseId);
    openPage("techDetails");
    loadTechTabs();
    openTechTab("infoTab");
  }

  function openTechTab(tabId) {
    document.querySelectorAll(".tab-section").forEach(t => t.classList.remove("active-tab"));
    const el = document.getElementById(tabId);
    if (el) el.classList.add("active-tab");
  }

  function loadTechTabs() {
    let c = currentTechCase;
    if (!c) return;

    document.getElementById("techDetailsHeader").innerHTML = `
      <b>${c.name}</b> â€” ${c.type}<br>
      Ù…Ù„Ù: ${c.file} | Lab: ${c.labNumber}<br>
      Ø·Ø¨ÙŠØ¨: ${c.doctor} | Ø¹ÙŠØ§Ø¯Ø©: ${c.clinic}<br>
      ÙÙ†ÙŠ: ${c.assignedTech || "â€”"}<br>
      Ø­Ø§Ù„Ø©: ${c.status}
    `;

    document.getElementById("infoTab").innerHTML = `
      <b>File:</b> ${c.file}<br>
      <b>Patient:</b> ${c.name}<br>
      <b>Doctor:</b> ${c.doctor}<br>
      <b>Clinic:</b> ${c.clinic}<br>
      <b>Case Type:</b> ${c.type}<br>
      <b>Next Appointment:</b> ${c.next || "â€”"}<br>
      <b>Status:</b> ${c.status}<br>
      <b>Lab Number:</b> ${c.labNumber}<br>
    `;

    document.getElementById("notesTab").innerHTML = `
      <h3>ğŸ“ Doctor Notes</h3>
      <p>${c.doctorNotes || "â€”"}</p>
    `;

    document.getElementById("requestTab").innerHTML = `
      <h3>ğŸ“˜ Doctor Request</h3>
      <p>${c.doctorRequest || "â€”"}</p>
    `;

    let imgHtml = "";
    if (c.images && c.images.length) {
      c.images.forEach(img => {
        imgHtml += `<img src="${img.url}" style="width:100%;border-radius:8px;margin-bottom:8px;">`;
      });
    } else imgHtml = "<p>No images uploaded</p>";
    document.getElementById("imagesTab").innerHTML = imgHtml;

    document.getElementById("trackTab").innerHTML = `
      <h3>ğŸ“Š Tracking</h3>
      <p>Entered Clinic â†’ Transit â†’ Arrived Lab â†’ Assigned Technician â†’ In Progress â†’ Completed</p>
    `;

    document.getElementById("r4Tab").innerHTML = `
      <button onclick="openR4('${c.file}')" class="assist-btn" style="background:#2c5282;">
        ğŸ”— Open in R4
      </button>
    `;

    document.getElementById("actionsTab").innerHTML = `
      <button class="assist-btn" onclick="completeCase('${c.id}')">âœ” Complete</button>
      <button class="assist-btn" style="background:#E68A21;" onclick="returnCase('${c.id}')">â†© Return</button>
    `;
  }

  function openR4(fileNumber) {
    // Ø¹Ø¯Ù„ÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· Ø­Ø³Ø¨ Ù†Ø¸Ø§Ù… R4 Ø¹Ù†Ø¯ÙƒÙ…
    window.open("https://hospital-r4-system.example.com/patient?file=" + fileNumber, "_blank");
  }

  function completeCase(caseId) {
    let cases = JSON.parse(localStorage.getItem("dsa_cases") || "[]");
    let target = cases.find(c => c.id == caseId);
    target.status = "CLINIC_RECEIVED";
    target.completeTime = new Date().toLocaleString();
    localStorage.setItem("dsa_cases", JSON.stringify(cases));
    alert("âœ” ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„Ø© ÙƒÙ€ Completed / Clinic Received");
    openPage("dashboard");
  }

  function returnCase(caseId) {
    let cases = JSON.parse(localStorage.getItem("dsa_cases") || "[]");
    let target = cases.find(c => c.id == caseId);
    target.status = "RETURNED";
    target.returnTime = new Date().toLocaleString();
    localStorage.setItem("dsa_cases", JSON.stringify(cases));
    alert("â†© ØªÙ… ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø§Ù„Ø© ÙƒÙ€ Returned (Ø±Ø§Ø¬Ø¹Ø©)");
    openPage("dashboard");
  }
</script>
</body>
</html>
