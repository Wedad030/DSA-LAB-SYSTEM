<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>DSA Lab System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    body {
      margin: 0;
      background: #f4f7fb;
      color: #222;
    }
    .app {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 24px 8px 40px;
    }
    .card {
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.05);
      padding: 24px 22px;
      width: 100%;
      max-width: 500px;
    }
    h1, h2, h3 {
      margin-top: 0;
      margin-bottom: 12px;
    }
    h1 { font-size: 1.5rem; }
    h2 { font-size: 1.2rem; }
    p { margin: 8px 0; }

    .view { display: none; }
    .view.active { display: block; }

    .field {
      margin-bottom: 14px;
    }
    .field label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 4px;
    }
    .field input, .field select, .field textarea {
      width: 100%;
      padding: 9px 10px;
      border-radius: 8px;
      border: 1px solid #ccd3e0;
      font-size: 0.9rem;
    }
    .field textarea { resize: vertical; min-height: 60px; }

    .btn {
      display: inline-block;
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 0.95rem;
      cursor: pointer;
      background: #2e7d32;
      color: #fff;
    }
    .btn.secondary {
      background: #e0e4ef;
      color: #333;
    }
    .btn.full { width: 100%; text-align: center; }

    .top-title {
      font-weight: 600;
      font-size: 0.85rem;
      color: #4d5b78;
      margin-bottom: 6px;
    }

    .muted { color: #6b7280; font-size: 0.85rem; }

    .greeting-main {
      font-size: 1.1rem;
      line-height: 1.7;
      margin-bottom: 8px;
    }
    .greeting-en {
      font-size: 0.9rem;
      color: #4b5563;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #e8f5e9;
      color: #1b5e20;
      font-size: 0.8rem;
      margin-bottom: 10px;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .dash-item {
      padding: 10px 12px;
      border-radius: 12px;
      background: #ffffff;
      border: 1px solid #e1e4f0;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
    }
    .dash-item span.icon {
      font-size: 1.1rem;
    }

    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
    }
    .tag.green { background:#e8f5e9; color:#1b5e20; }
    .tag.blue { background:#e3f2fd; color:#0d47a1; }
    .tag.orange { background:#fff3e0; color:#e65100; }
    .tag.red { background:#ffebee; color:#b71c1c; }

    .case-summary {
      margin-top: 10px;
      padding: 10px 12px;
      background:#f9fafb;
      border-radius: 10px;
      border: 1px dashed #d1d5db;
      font-size: 0.85rem;
    }

    .qr-box {
      text-align: center;
      margin-top: 10px;
    }
    .qr-box img {
      margin-top: 6px;
      background:#fff;
      padding: 6px;
      border-radius: 8px;
      border:1px solid #e5e7eb;
    }

    canvas {
      width: 100%;
      max-width: 100%;
      background:#f3f4f6;
      border-radius: 10px;
      border:1px solid #d1d5db;
      margin-top: 6px;
    }

    .stats-block {
      margin-top: 10px;
      padding: 10px 12px;
      background:#f9fafb;
      border-radius: 10px;
      border:1px solid #e5e7eb;
      font-size: 0.85rem;
    }
    .stats-row {
      display:flex;
      justify-content:space-between;
      margin:2px 0;
    }

    @media (min-width: 720px) {
      .app {
        align-items: center;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- LOGIN PAGE -->
    <section id="loginPage" class="view active">
      <div class="card">
        <div class="top-title">DSA Lab System â€¢ Login</div>
        <h1>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
        <p class="muted">Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…ÙˆØ­Ø¯Ø© Ù„Ù„Ù…Ø¹Ù…Ù„.</p>
        <div class="field">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
          <input id="loginUsername" type="text" placeholder="Ù…Ø«Ø§Ù„: wedad" />
        </div>
        <div class="field">
          <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <input id="loginPassword" type="password" placeholder="â€¢â€¢â€¢â€¢" />
        </div>
        <button class="btn full" onclick="handleLogin()">Ø¯Ø®ÙˆÙ„</button>
        <p id="loginError" class="muted" style="color:#b91c1c;display:none;margin-top:8px;">
          Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©ØŒ ØªØ£ÙƒØ¯ÙŠ Ù…Ù† Ø§Ù„Ø§Ø³Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.
        </p>
      </div>
    </section>

    <!-- GREETING PAGE -->
    <section id="greetingPage" class="view">
      <div class="card">
        <div class="chip">ğŸ’š Lab Vibes â€¢ Ù…Ø²Ø§Ø¬ Ø§Ù„Ù…Ø¹Ù…Ù„</div>
        <h1>ÙŠØ§ Ù…Ø±Ø­Ø¨Ø§Ù‹</h1>
        <p id="greetingAr" class="greeting-main"></p>
        <p id="greetingEn" class="greeting-en"></p>
        <button class="btn full" style="margin-top:16px;" onclick="goToDashboard()">
          Ù„Ù†Ø¨Ø¯Ø£ Ø§Ù„Ù†Ø¸Ø§Ù… ğŸš€
        </button>
        <button class="btn secondary full" style="margin-top:8px;" onclick="logout()">
          ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
        </button>
      </div>
    </section>

    <!-- DASHBOARD -->
    <section id="dashboardPage" class="view">
      <div class="card">
        <div class="top-title">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</div>
        <h1>DSA Lab Workflow</h1>
        <p class="muted">Ø§Ø®ØªØ§Ø±ÙŠ Ù…Ø§ ØªØ±ÙŠØ¯ÙŠÙ† Ø¥Ù†Ø¬Ø§Ø²Ù‡ Ø§Ù„ÙŠÙˆÙ… ğŸ‘‡</p>
        <div class="dashboard-grid">
          <div class="dash-item" onclick="showView('clinicFormPage')">
            <div>
              ğŸ“¥ Ø¥Ø¯Ø®Ø§Ù„ Ø­Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©
              <div class="muted">Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø±Ø­Ù„Ø© Ù…Ù† Ø§Ù„ÙƒØ±Ø³ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¹Ù…Ù„</div>
            </div>
            <span class="icon">â•</span>
          </div>
          <div class="dash-item" onclick="showView('receivePage')">
            <div>
              ğŸ“¦ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù…Ø¹Ù…Ù„
              <div class="muted">ØªØ£ÙƒÙŠØ¯ Ø§Ù„ÙˆØµÙˆÙ„ + ØªÙˆÙ‚ÙŠØ¹ + Scan</div>
            </div>
            <span class="icon">âœï¸</span>
          </div>
          <div class="dash-item" onclick="openStatsPin()">
            <div>
              ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
              <div class="muted">Ù…Ø­Ø¬ÙˆØ¨Ø© Ø¨Ø±Ù‚Ù… Ø³Ø±ÙŠ Ø®Ø§Øµ</div>
            </div>
            <span class="icon">ğŸ”</span>
          </div>
        </div>
        <button class="btn secondary full" style="margin-top:16px;" onclick="logout()">
          ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
        </button>
      </div>
    </section>

    <!-- CLINIC FORM PAGE -->
    <section id="clinicFormPage" class="view">
      <div class="card">
        <div class="top-title">Step 1 â€¢ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ù† Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</div>
        <h2>ØªØ³Ø¬ÙŠÙ„ Ø­Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
        <div class="field">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ù„Ù (File Number)</label>
          <input id="fileNumber" type="text" />
        </div>
        <div class="field">
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ (Patient Name)</label>
          <input id="patientName" type="text" />
        </div>
        <div class="field">
          <label>Ø±Ù‚Ù… Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© (Clinic No.)</label>
          <input id="clinicNumber" type="text" />
        </div>
        <div class="field">
          <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨ (Doctor Name)</label>
          <input id="doctorName" type="text" />
        </div>
        <div class="field">
          <label>Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„Ø© (Case Type / Department)</label>
          <select id="caseType">
            <option value="">Ø§Ø®ØªØ§Ø±ÙŠ...</option>
            <option value="RPD">RPD</option>
            <option value="CROWN">Crown / PFM</option>
            <option value="CD">CD / Complete Denture</option>
            <option value="ORTHO">Ortho</option>
            <option value="IMPLANT">Implant</option>
            <option value="OTHER">Other</option>
          </select>
        </div>
        <div class="field">
          <label>ØµÙˆØ±Ø© Ø£Ùˆ Snap Ù„Ù„Ø·Ù„Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="orderImage" type="file" accept="image/*" />
        </div>
        <button class="btn full" onclick="createClinicCase()">Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØªÙˆØ²ÙŠØ¹Ù‡Ø§ âœ…</button>
        <button class="btn secondary full" style="margin-top:8px;" onclick="showView('dashboardPage')">
          Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        </button>

        <div id="clinicResult" class="case-summary" style="display:none;"></div>
        <div id="qrBox" class="qr-box" style="display:none;"></div>
      </div>
    </section>

    <!-- RECEIVE PAGE -->
    <section id="receivePage" class="view">
      <div class="card">
        <div class="top-title">Step 2 â€¢ Ø§Ø³ØªÙ„Ø§Ù… ÙÙŠ Ø§Ù„Ù…Ø¹Ù…Ù„</div>
        <h2>Ø§Ø³ØªÙ„Ø§Ù… Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù…Ø¹Ù…Ù„</h2>
        <div class="field">
          <label>Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ù…Ù„ (Auto-Lab-Number Ø£Ùˆ Ù…Ù† Ø§Ù„Ù€ QR)</label>
          <input id="receiveLabNumber" type="text" placeholder="Ù…Ø«Ø§Ù„: LAB-1001" />
        </div>
        <button class="btn full" onclick="findCaseForReceive()">Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø­Ø§Ù„Ø© ğŸ”</button>
        <button class="btn secondary full" style="margin-top:8px;" onclick="showView('dashboardPage')">
          Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        </button>

        <div id="receiveDetails" style="display:none; margin-top:14px;">
          <div class="case-summary" id="receiveSummary"></div>

          <div class="field">
            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù… (Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ / Ø§Ù„ÙÙ†ÙŠ)</label>
            <input id="receiverName" type="text" placeholder="Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§" />
          </div>

          <div class="field">
            <label>ØªÙˆÙ‚ÙŠØ¹ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (ÙˆÙ‚Ù‘Ø¹ÙŠ Ø¨Ø¥ØµØ¨Ø¹Ùƒ Ø£Ùˆ Ø§Ù„Ù…Ø§ÙˆØ³)</label>
            <canvas id="signCanvas" height="160"></canvas>
            <button class="btn secondary full" style="margin-top:6px;" onclick="clearSignature()">Ù…Ø³Ø­ Ø§Ù„ØªÙˆÙ‚ÙŠØ¹</button>
          </div>

          <div class="field">
            <label>Ø±ÙØ¹ ØµÙˆØ±Ø© / Scan Ù„Ù„Ø­Ø§Ù„Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
            <input id="receiveScan" type="file" accept="image/*" />
          </div>

          <button class="btn full" onclick="confirmReceive()">ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø­Ø§Ù„Ø© âœ…</button>
          <p id="receiveMsg" class="muted" style="display:none;margin-top:10px;color:#1b5e20;">
            ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­ØŒ Ø´ÙƒØ±Ø§Ù‹ Ù„Ø­Ø±ØµÙƒâ€¦ Keep shining âœ¨
          </p>
        </div>
      </div>
    </section>

    <!-- STATS PIN PAGE -->
    <section id="statsPinPage" class="view">
      <div class="card">
        <div class="top-title">ğŸ” Protected</div>
        <h2>Ø¯Ø®ÙˆÙ„ Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
        <p class="muted">Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ùƒ Ø£Ù†Øª ÙÙ‚Ø·. Ø£Ø¯Ø®Ù„ÙŠ Ø±Ù‚Ù… Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª.</p>
        <div class="field">
          <label>Statistics PIN</label>
          <input id="statsPinInput" type="password" />
        </div>
        <button class="btn full" onclick="checkStatsPin()">Ø¯Ø®ÙˆÙ„</button>
        <button class="btn secondary full" style="margin-top:8px;" onclick="showView('dashboardPage')">
          Ø±Ø¬ÙˆØ¹
        </button>
        <p id="statsPinError" class="muted" style="display:none;color:#b91c1c;margin-top:8px;">
          Ø±Ù‚Ù… ØºÙŠØ± ØµØ­ÙŠØ­.
        </p>
      </div>
    </section>

    <!-- STATS PAGE -->
    <section id="statsPage" class="view">
      <div class="card">
        <div class="top-title">ğŸ“Š Lab Analytics</div>
        <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</h2>
        <p class="muted">ÙŠØ§ Ù…Ø±Ø­Ø¨Ø§ Ù‚Ø§Ø¦Ø¯Ø© Ø§Ù„Ù…Ø¹Ù…Ù„â€¦ Ø¬Ø§Ù‡Ø²Ø© Ù†Ø´ÙˆÙ Ø§Ù„Ø£Ø±Ù‚Ø§Ù…ØŸ ÙŠØ§Ø±Ø¨ ØªØ¨Ø´Ø±Ùƒ Ø¨Ø§Ù„Ø®ÙŠØ± ğŸ’š</p>

        <div id="statsContent" class="stats-block"></div>

        <button class="btn secondary full" style="margin-top:12px;" onclick="showView('dashboardPage')">
          Ø±Ø¬ÙˆØ¹ Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        </button>
      </div>
    </section>
  </div>

  <script>
    // ====== BASIC CONFIG ======
    const LOGIN_USER = "wedad";   // Ø§Ø³Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„
    const LOGIN_PASS = "1234";    // ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ø¬Ù…ÙŠØ¹
    const STATS_PIN  = "2580";    // Ø±Ù‚Ù… Ø³Ø±ÙŠ Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (ØºÙŠØ±ÙŠÙ‡ Ù…Ù† Ù‡Ù†Ø§)

    // Ù‚Ø§Ø¦Ù…Ø© Ø¹Ø¨Ø§Ø±Ø§Øª ØªØ±Ø­ÙŠØ¨ÙŠØ© (Ø¹Ø±Ø¨ÙŠ + Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)
    const greetings = [
      {
        ar: "ÙŠØ§ Ù…Ø±Ø­Ø¨Ø§ ğŸ¤ Ø¬Ø§Ù‡Ø²ÙŠÙ† Ù†Ø´ÙˆÙ Ø§Ù„Ù†Ø¸Ø§Ù…ØŸ ÙŠØ§Ø±Ø¨ ØªØ¨Ø´Ù‘Ø± Ø®Ø·ÙˆØ§ØªÙƒÙ… Ø¨Ø§Ù„Ø®ÙŠØ± ğŸ’š",
        en: "Welcome! Ready to see todayâ€™s workflow? May every case bring good news ğŸ’š"
      },
      {
        ar: "Ù†ÙˆØ±ØªÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… ğŸ¤ Ø§Ù„ÙŠÙˆÙ… ÙŠÙˆÙ… Ø¥Ù†Ø¬Ø§Ø²â€¦ Ø¬Ø§Ù‡Ø²ÙŠÙ†ØŸ ÙŠØ§Ø±Ø¨ ÙŠØ¬Ø¹Ù„Ù‡Ø§ Ø¨Ø¯Ø§ÙŠØ© Ø®ÙŠØ± ğŸ’š",
        en: "You just lit up the system ğŸ¤ Let today be full of wins and smooth cases ğŸ’š"
      },
      {
        ar: "Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙØ±ÙŠÙ‚ Ø§Ù„Ù…Ø¹Ù…Ù„ Ø§Ù„Ù…Ø¨Ø¯Ø¹ âœ¨ Ø®Ø°ÙˆØ§ Ù†ÙØ³ Ø¹Ù…ÙŠÙ‚ ÙˆØ®Ù„ÙˆÙ†Ø§ Ù†Ø±ØªÙ‘Ø¨ ÙŠÙˆÙ…Ù†Ø§ Ø³ÙˆØ§ ğŸ’š",
        en: "Hello creative lab team âœ¨ Deep breathâ€¦ letâ€™s organize the whole day together ğŸ’š"
      }
    ];

    // Ø§Ù„ÙÙ†ÙŠÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø³Ù… â€“ Ø¹Ø¯Ù„ÙŠ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙˆØ§Ù„Ø§Ù‚Ø³Ø§Ù… Ø¨Ø±Ø§Ø­ØªÙƒ
    const techniciansByDept = {
      RPD: [
        "ABDULLAH RPD","Alsakhri RPD","Abdullatif RPD",
        "HAYAM RPD","RASHEED RPD","MANSOR RPD","AlSharfan RPD"
      ],
      CROWN: [
        "Ayman PFM","Sultan PFM","ALQAHTANI CD","Kushan CD","Qasem CD"
      ],
      CD: [
        "Abdullah CD","yahya CD","Turki O","Waleed O"
      ],
      OTHER: [
        "Ahamed TM","Alkhamis","Alotaibi","W.Alsuwiri","ALAA","FAISAL","ALOUD"
      ]
    };

    // ====== STATE & STORAGE ======
    let cases = loadCases();
    let currentReceiveCaseId = null;

    function loadCases() {
      try {
        const raw = localStorage.getItem("dsa_cases");
        return raw ? JSON.parse(raw) : [];
      } catch(e) {
        console.error(e);
        return [];
      }
    }
    function saveCases() {
      localStorage.setItem("dsa_cases", JSON.stringify(cases));
    }

    function showView(id) {
      document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    function handleLogin() {
      const u = document.getElementById("loginUsername").value.trim().toLowerCase();
      const p = document.getElementById("loginPassword").value.trim();
      const errorEl = document.getElementById("loginError");

      if (u === LOGIN_USER.toLowerCase() && p === LOGIN_PASS) {
        errorEl.style.display = "none";
        showGreeting();
      } else {
        errorEl.style.display = "block";
      }
    }

    function showGreeting() {
      const random = greetings[Math.floor(Math.random()*greetings.length)];
      document.getElementById("greetingAr").innerText = random.ar;
      document.getElementById("greetingEn").innerText = random.en;
      showView("greetingPage");
    }

    function goToDashboard() {
      showView("dashboardPage");
    }

    function logout() {
      document.getElementById("loginUsername").value = "";
      document.getElementById("loginPassword").value = "";
      showView("loginPage");
    }

    // ====== AUTO LAB NUMBER + ROUND ROBIN TECH ======
    function generateLabNumber() {
      const last = cases.length ? cases[cases.length - 1].labNumber : null;
      if (!last) return "LAB-1001";
      const num = parseInt(last.split("-")[1] || "1000", 10) + 1;
      return "LAB-" + num;
    }

    function getNextTechnician(deptKey) {
      const list = techniciansByDept[deptKey] || techniciansByDept.OTHER;
      if (!list || list.length === 0) return "Unassigned";

      const key = "rr_index_" + deptKey;
      let idx = parseInt(localStorage.getItem(key) || "0", 10);
      const tech = list[idx % list.length];
      idx = (idx + 1) % list.length;
      localStorage.setItem(key, idx.toString());
      return tech;
    }

    // Map from caseType select to deptKey
    function mapCaseTypeToDept(caseType) {
      if (caseType === "RPD") return "RPD";
      if (caseType === "CROWN") return "CROWN";
      if (caseType === "CD") return "CD";
      return "OTHER";
    }

    // ====== CLINIC CASE CREATION ======
    function createClinicCase() {
      const fileNumber = document.getElementById("fileNumber").value.trim();
      const patientName = document.getElementById("patientName").value.trim();
      const clinicNumber = document.getElementById("clinicNumber").value.trim();
      const doctorName = document.getElementById("doctorName").value.trim();
      const caseType = document.getElementById("caseType").value;

      if (!fileNumber || !patientName || !clinicNumber || !doctorName || !caseType) {
        alert("Ø±Ø¬Ø§Ø¡Ù‹ Ø¹Ø¨Ø¦ÙŠ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸.");
        return;
      }

      const now = new Date();
      const createdAt = now.toLocaleString("ar-SA", { dateStyle: "short", timeStyle: "short" });
      const labNumber = generateLabNumber();
      const deptKey = mapCaseTypeToDept(caseType);
      const technician = getNextTechnician(deptKey);

      const newCase = {
        id: Date.now(),
        fileNumber,
        patientName,
        clinicNumber,
        doctorName,
        caseType,
        deptKey,
        createdAt,
        labNumber,
        phase: "Entered from Clinic",
        status: "IN_CLINIC",
        technician,
        receiveInfo: null
      };

      cases.push(newCase);
      saveCases();

      // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
      const res = document.getElementById("clinicResult");
      res.style.display = "block";
      res.innerHTML = `
        <div><span class="tag green">Ø¬Ø§Ù‡Ø²Ø© ğŸ‰</span></div>
        <div>Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ù…Ù„: <strong>${labNumber}</strong></div>
        <div>Ø§Ù„Ù…Ø±ÙŠØ¶: <strong>${patientName}</strong> â€¢ Ù…Ù„Ù: ${fileNumber}</div>
        <div>Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©: ${clinicNumber} â€¢ Ø§Ù„Ø·Ø¨ÙŠØ¨: ${doctorName}</div>
        <div>Ø§Ù„Ù‚Ø³Ù…: ${caseType} â€¢ Ø§Ù„ÙÙ†ÙŠ: <strong>${technician}</strong></div>
        <div class="muted" style="margin-top:6px;">
          ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© ÙƒÙ€ <strong>Entered from Clinic</strong> ÙˆØªÙ… ØªÙˆØ²ÙŠØ¹Ù‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙÙ†ÙŠ.
        </div>
      `;

      // QR Ø¨Ø³ÙŠØ· Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®Ø¯Ù…Ø© Ù…Ø¬Ø§Ù†ÙŠØ© (ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ±Ù‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹)
      const qrBox = document.getElementById("qrBox");
      const qrData = `DSA-LAB:${labNumber}`;
      qrBox.style.display = "block";
      qrBox.innerHTML = `
        <div class="muted">Ø§Ù…Ø³Ø­ Ø§Ù„Ù€ QR Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø­Ø§Ù„Ø©:</div>
        <img alt="QR" src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(qrData)}">
      `;

      // Ø±Ø³Ø§Ù„Ø© ØªØ´Ø¬ÙŠØ¹ÙŠØ© ØµØºÙŠØ±Ø©
      alert("ÙŠØ§ Ø³Ù„Ø§Ù…! Ø§Ù„Ø­Ø§Ù„Ø© Ø¯Ø®Ù„Øª Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØªÙˆØ²Ø¹Øª Ø¹Ù„Ù‰ Ø§Ù„ÙÙ†ÙŠ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ ğŸ’š");

      // Ø¨Ø¥Ù…ÙƒØ§Ù†Ùƒ ØªØ±Ùƒ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙƒÙ…Ø§ Ù‡ÙŠ Ø£Ùˆ Ù…Ø³Ø­Ù‡Ø§:
      // document.getElementById("fileNumber").value = "";
      // ...
    }

    // ====== RECEIVE IN LAB ======
    function findCaseForReceive() {
      const labNumber = document.getElementById("receiveLabNumber").value.trim();
      if (!labNumber) {
        alert("Ø§ÙƒØªØ¨ÙŠ Ø±Ù‚Ù… Ø§Ù„Ù…Ø¹Ù…Ù„ Ø£ÙˆÙ„Ø§Ù‹.");
        return;
      }
      const c = cases.find(c => c.labNumber === labNumber);
      if (!c) {
        alert("Ù…Ø§ ÙˆØ¬Ø¯Ù†Ø§ Ø­Ø§Ù„Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…. ØªØ£ÙƒØ¯ÙŠ Ù…Ù†Ù‡.");
        return;
      }
      currentReceiveCaseId = c.id;
      const summary = document.getElementById("receiveSummary");
      summary.innerHTML = `
        <div>Ø§Ù„Ù…Ø±ÙŠØ¶: <strong>${c.patientName}</strong> â€¢ Ù…Ù„Ù: ${c.fileNumber}</div>
        <div>Ø§Ù„Ù‚Ø³Ù…: ${c.caseType} â€¢ Ø§Ù„ÙÙ†ÙŠ: <strong>${c.technician}</strong></div>
        <div>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: <span class="tag blue">${c.phase}</span></div>
        <div class="muted">Ø£ÙÙ†Ø´Ø¦Øª: ${c.createdAt} â€¢ Ø±Ù‚Ù… Ù…Ø¹Ù…Ù„: ${c.labNumber}</div>
      `;
      document.getElementById("receiveDetails").style.display = "block";
      document.getElementById("receiveMsg").style.display = "none";
      clearSignature();
    }

    // Canvas signature
    const canvas = document.getElementById("signCanvas");
    let ctx = canvas ? canvas.getContext("2d") : null;
    let drawing = false;

    function startDraw(e) {
      drawing = true;
      ctx.beginPath();
      const pos = getPos(e);
      ctx.moveTo(pos.x, pos.y);
    }
    function draw(e) {
      if (!drawing) return;
      const pos = getPos(e);
      ctx.lineTo(pos.x, pos.y);
      ctx.strokeStyle = "#10b981";
      ctx.lineWidth = 2;
      ctx.stroke();
    }
    function endDraw() {
      drawing = false;
    }
    function getPos(e) {
      const rect = canvas.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      return { x: clientX - rect.left, y: clientY - rect.top };
    }

    if (canvas && ctx) {
      canvas.addEventListener("mousedown", startDraw);
      canvas.addEventListener("mousemove", draw);
      canvas.addEventListener("mouseup", endDraw);
      canvas.addEventListener("mouseleave", endDraw);

      canvas.addEventListener("touchstart", function(e){ e.preventDefault(); startDraw(e); });
      canvas.addEventListener("touchmove", function(e){ e.preventDefault(); draw(e); });
      canvas.addEventListener("touchend", function(e){ e.preventDefault(); endDraw(e); });
    }

    function clearSignature() {
      if (!ctx) return;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function confirmReceive() {
      if (currentReceiveCaseId == null) {
        alert("Ø§Ø¨Ø­Ø«ÙŠ Ø¹Ù† Ø­Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹.");
        return;
      }
      const receiver = document.getElementById("receiverName").value.trim();
      if (!receiver) {
        alert("Ø§ÙƒØªØ¨ÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù….");
        return;
      }
      const now = new Date();
      const receiveAt = now.toLocaleString("ar-SA", { dateStyle: "short", timeStyle: "short" });

      const idx = cases.findIndex(c => c.id === currentReceiveCaseId);
      if (idx === -1) return;
      cases[idx].phase = "Received in Lab";
      cases[idx].status = "IN_LAB";
      cases[idx].receiveInfo = {
        receiver,
        receiveAt
      };
      saveCases();

      document.getElementById("receiveMsg").style.display = "block";
      alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù…Ø¹Ù…Ù„. ÙŠØ¹Ø·ÙŠÙƒ Ø§Ù„Ø¹Ø§ÙÙŠØ© ğŸ’š");
    }

    // ====== STATS ======
    function openStatsPin() {
      document.getElementById("statsPinInput").value = "";
      document.getElementById("statsPinError").style.display = "none";
      showView("statsPinPage");
    }

    function checkStatsPin() {
      const val = document.getElementById("statsPinInput").value.trim();
      if (val === STATS_PIN) {
        document.getElementById("statsPinError").style.display = "none";
        renderStats();
        showView("statsPage");
      } else {
        document.getElementById("statsPinError").style.display = "block";
      }
    }

    function renderStats() {
      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ù„Ù„ØªØ£ÙƒØ¯
      cases = loadCases();
      const total = cases.length;
      const inClinic = cases.filter(c => c.status === "IN_CLINIC").length;
      const inLab = cases.filter(c => c.status === "IN_LAB").length;

      const byDept = {};
      cases.forEach(c => {
        byDept[c.caseType] = (byDept[c.caseType] || 0) + 1;
      });

      let html = "";
      html += `<div class="stats-row"><span>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª</span><strong>${total}</strong></div>`;
      html += `<div class="stats-row"><span>ÙÙŠ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© / ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚</span><strong>${inClinic}</strong></div>`;
      html += `<div class="stats-row"><span>Ù…ÙØ³ØªÙ„Ù…Ø© ÙÙŠ Ø§Ù„Ù…Ø¹Ù…Ù„</span><strong>${inLab}</strong></div>`;
      html += `<hr style="margin:8px 0;border:none;border-top:1px solid #e5e7eb;">`;
      html += `<div class="muted" style="margin-bottom:4px;">ØªÙˆØ²ÙŠØ¹ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„Ø©:</div>`;
      Object.keys(byDept).forEach(k => {
        html += `<div class="stats-row"><span>${k}</span><strong>${byDept[k]}</strong></div>`;
      });

      document.getElementById("statsContent").innerHTML = html;
    }
  </script>
</body>
</html>
